#INCLUDE "TOTVS.CH"//"FIVEWIN.CH"

#DEFINE _ENTER CHR(13)+CHR(10)
/*                                                          
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Descri‡…o ³ PLANO DE MELHORIA CONTINUA                                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ITEM PMC  ³ Responsavel              ³ Data         |BOPS:		      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³      01  ³Flavio Luiz Vicco         ³17/05/2006    |00000098907       ³±±
±±³      02  ³Flavio Luiz Vicco         ³16/02/2006    |00000093467       ³±±
±±³      03  ³                          ³              |                  ³±±
±±³      04  ³                          ³              |                  ³±±
±±³      05  ³                          ³              |                  ³±±
±±³      06  ³                          ³              |                  ³±±
±±³      07  ³Erike Yuri da Silva       ³18/04/2006    |00000095857       ³±±
±±³      08  ³Flavio Luiz Vicco         ³17/05/2006    |00000098907       ³±±
±±³      09  ³Erike Yuri da Silva       ³18/04/2006    |00000095857       ³±±
±±³      10  ³Flavio Luiz Vicco         ³16/02/2006    |00000093467       ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ MATA690  ³ Autor ³ Ary Medeiros          ³ Data ³          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Carga MÁquina                                              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpL1 = Informa que sera executado em batch. Default = .F. ³±±
±±³          ³ ExpL2 = Informa se as datas do SC2 serao atualizadas pelo  ³±±
±±³          ³         Carga Maquina.Default = .T.                        ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAPCP                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/ 
Static lIsBatch   := .f.    //Inicializacao da variavel static indicando que o processamento nao eh batch
Static __nSetupAt := 0		//Inicializacao da variavel static indicando o valor do setup atual

User Function MYTA690(lBat,lAtuSC2,aAltParam)
Local i,k
Local nKey
Local nHdl
Local nTentativas	:= 0
Local cArqFerram
Local cCargaFile
Local cArqSH8
Local cBuffer
Local cKeyFerram
Local cKeySH8
Local cSalvaCab
Local cSalvaAviso
Local mv_par06Old
Local dDataOld
Local dDataIni
Local dDataFim
Local lOk			:= .T.
Local lFalse		:= .F.
Local lTrue			:= .T.
Local lContinua		:= .F.
Local aCampSH8
Local aCampSHE
Local aRet 			:= Array(9)
Local aRecursos 	:= {}
Local aTamSX3		:= {}
Local nTamSX1       := Len(SX1->X1_GRUPO)
Local cTexto        := ""
Local bProcess      := {|oCenterPanel|U_YA690Aloc(@aRet,@aRecursos,@lOk,,oCenterPanel)}
Local aInfoProc     := {}
Local lUsaNewPrc    := UsaNewPrc()
Local cEmp690     	:= Alltrim(STR(u_Y690FilNum(FwCodFil())))

Local nLinha        := 0
Local lIntPPI       := PCPIntgPPI()
PRIVATE cSeqCarga :=GetMV("MV_SEQCARG",,Space(6))
PRIVATE l690AtuSC2:= .T.
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Define qual a precisao utilizada pelo SIGAPCP                ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
PRIVATE nPrecisao := GETMV("MV_PRECISA")

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Define variavel para selecao de recursos                     ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
PRIVATE cRecSele  := ""

PRIVATE lReprocessa := .F.  // Flag para ReAlocar Carga Maquina
PRIVATE lAlterou    := .F.  // Flag para informar se alterou alguma prioridade
PRIVATE lProcesPPI  := .F.  // Flag para indicar se realizou a integração com o PCFactory
PRIVATE aOcorrencia := {}

PRIVATE aRecDepend  := {}  // Array que ira controlar operacoes com recursos dependentes (G2_TPLINHA="D")

PRIVATE cDirPcp                                      
PRIVATE cNameCarga	:= "CARGA"+If(Empty(cEmp690),cNumEmp,cEmp690) //Nome do arquivo de Carga
PRIVATE cNameFerr	:= "FERR" +If(Empty(cEmp690),cNumEmp,cEmp690) //Nome do arquivo de Ferramenta

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Estas variaveis indicam para as funcoes de validacao qual    ³
//³ programa as esta chamando                                    ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
PRIVATE l240:=.F.,l250 :=.F.,l241:=.F.,l242:=.F.,l261:=.F.,l185:=.F.,l650:=.F.

DEFAULT lBat      := .F.
DEFAULT lAtuSC2   := .T.
Default aAltParam := {}

lIsBatch 	:= ( lBat .or. IsBlind())
l690AtuSC2	:= lAtuSC2
CHKFILE("SZK",.T.)
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Verifica a permissao do programa em relacao aos modulos      ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If AMIIn(10)
	PRIVATE cTipoTemp	:=GetMV("MV_TPHR")

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Flag que indica se rodou alocacao ou nao                     ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	PRIVATE lAlocou:=.F.

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Diretorio do processamento                                   ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If GetMV("MV_PROCPCP",.T.)
		cDirPcp := Alltrim(GetMV("MV_PROCPCP"))
		If u_Y690NomeLongo(cDirPcp)
			help(" ", 1, "A690NLONGO",,"MV_PROCPCP " + cDirPCP,4,0)
			Return
		Endif
	Else
		cDirPcp := Alltrim(GetMV("MV_DIRPCP"))
		If u_Y690NomeLongo(cDirPcp)		
			help(" ", 1, "A690NLONGO",,"MV_DIRPCP " + cDirPCP,4,0)
			Return
		Endif
	EndIf

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Diretorio dos dados                                          ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	PRIVATE cDirDados	:= Alltrim(GetMV("MV_DIRPCP"))

	If u_Y690NomeLongo(cDirDados)		
		help(" ", 1, "A690NLONGO",,"MV_DIRPCP " + cDirDados,4,0)
		Return
	Endif

	cDrvCarga := __LocalDriver

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Parametros utilizados                                                                              ³
	//³ mv_par01 - 1 - Alocacao pelo Fim   2 - Pelo inicio                                                 ³
	//³ mv_par02 - Periodo  10 a 999 dias                                                                  ³
	//³ mv_par03 - 1 - Utiliza Ferramenta  2 - Nao Utiliza                                                 ³
	//³ mv_par04 - 1 - Considera Saldo OP  2 - Considera Saldo da Operacao                                 ³
	//³ mv_par05 - 1 - Considera OPs Sacramentadas  2 - Nao considera                                      ³
	//³ mv_par06 - 1 - Uma cor para cada OP  2 - OPs Sacr. em Verm. e Normais em Azul                      ³
	//³ mv_par07/08 - Data de Entrega de/ate                                                               ³
	//³ mv_par09/10 - Ordens de Producao de/ate                                                            ³
	//³ mv_par11/12 - Produto de/ate                                                                       ³
	//³ mv_par13/14 - Grupo de/ate                                                                         ³
	//³ mv_par15    - Data Inicial                                                                         ³
	//³ mv_par16/17 - Tipo produto de/ate                                                                  ³
	//³ mv_par18    - Avalia Ocorrencia : Durante/Final                                                    ³
	//³ mv_par19    - Filtra recursos 1 - Sim 2 - Nao                                                      ³
	//³ mv_par20    - Seleciona Cal. Alternativo 1 - Sim 2 - Nao                                           ³
	//³ mv_par21    - Aloca OPS 1 - Firmes 2 - Previstas 3 - Ambas                                         ³
	//³ mv_par22    - Mostra Carga Maquina apos processamento 1-Sim; 2-Nao                                 ³
	//³ mv_par23    - Saida do Grafico 1-Protheus;2-Escolher;3-MS-Project se existir;4-Protheus sem quebra ³
	//³ mv_par24    - Mostra recurso sem alocacao  1-Sim; 2=Nao                                            ³
	//³ mv_par25/26 - Linha de Producao de/ate                                                             ³
	//³ mv_par27    - Desalocar OP parcialmente alocada 1 - Sim 2 - Nao (Somente para alocacao pelo FIM)   ³
	//³ mv_par28    - Ignorar operac. seguintes         1 - Sim 2 - Nao (Somente para alocacao pelo INICIO)³
	//³ mv_par29    - Ao termino do processamento       1 - Retorna ao menu 2 - Retorna aos parametros     ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	U_YAQuestion(.F., lBat, aAltParam)

	Private dDataPar  := mv_par15   // Data utilizada para inicio da Carga de Maquina
	Private lMaqXQuant:= .F.        // Verifica se utiliza Maquina de acordo com as quantidades
	Private nIntQtd   :=  9         // Utilizado quando lMaqXQuant == .T. (IBRATIN)
	Private nDecQtd   :=  2         // Utilizado quando lMaqXQuant == .T. (IBRATIN)

	IF GETMV("MV_MAQXQTD",.T.)
		lMaqXQuant := .T.       // Especifico para IBRATIN
		aTamSX3 := TamSX3("Z1_QUANT")
		nIntQtd := aTamSX3[1]
		nDecQtd := aTamSX3[2]
	Endif

	Private lShowOCR := .F., lOcorreu := .F., cSavScrOCR, dDataBrowse := dDataPar
	Private oRegua
	Private nRegua:=0
	Private nTotRegua:=0 
	Private bBlock	
	
	If !u_Y690IsBat()
		If lUsaNewPrc
			bBlock:={|| oCenterPanel:IncRegua1() }
		Else
			bBlock:={|| oRegua:Set(++nRegua),SysRefresh()}
		EndIf
	EndIf

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Verifica se esta em modo exclusivo para a filial                       ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	lContinua := .t.
	If !lContinua  // (lContinua := OpenSemSH8() )
		Help(" ",1,"SH8EmUso")
	Else
		If Empty(cDirPcp)
			HELP(' ',1,"Configuração de Parametros" ,,"Parametro não configurado",2,0,,,,,,{"Definir as informações dos parametros MV_PROCPCP, pelo configurador" }) 
			Return
		Else
			cDirPcp += IIf( Right(cDirPcp,1) # "\" , "\" , "" )
		EndIf
		
		If Empty(cDirDados)
			HELP(' ',1,"Configuração de Parametros" ,,"Parametro não configurado",2,0,,,,,,{"Definir as informações dos parametros MV_DIRPCP, pelo configurador"})
			Return
		Else
			cDirDados += IIf( Right(cDirDados,1) # "\" , "\" , "" )
		EndIf
		lOk:=u_YADirProc()
		If lOk
			aButton := Array(6)
			nLinha  := 300

			If SuperGetMV("MV_PCPATOR",.F.,.F.)
				Help(" ",1,"A690MV1_ATIVO")//Parâmetro MV_PCPATOR está ativo, logo o resultado do cálculo do carga máquina é considerado equivocado, pois não considera as Operações ligadas as ordens (SHY)//Desative o parâmetro MV_PCPATOR
			EndIf

			DEFINE MSDIALOG oDlg FROM  100,100 TO nLinha,665 TITLE OemToAnsi("Carga de Máquina") PIXEL	//"Carga de M quina"
			@ 10,015 TO 58,266 LABEL "" OF oDlg  PIXEL
			@ 21,025 SAY OemToAnsi("Este programa aloca todos os recursos utilizados nas Ordens de Produção e no período") SIZE 215,8 OF oDlg PIXEL	//"Este programa aloca todos os recursos utilizados nas Ordens de Produ‡„o e no per¡odo"
			@ 31,025 SAY OemToAnsi("definidos através dos parâmetros. Ap¢s a execução da rotina o usuário poder,") SIZE 215,8 OF oDlg PIXEL	//"definidos atrav‚s dos parƒmetros. Ap¢s a execu‡„o da rotina o usu rio poder "
			@ 41,025 SAY OemToAnsi("rodar o relat¢rio de Carga Máquina e conferir a alocação.") SIZE 215,8 OF oDlg PIXEL	//"rodar o relat¢rio de Carga M quina e conferir a aloca‡„o."
			@ 65,015 METER oRegua VAR nRegua TOTAL nTotRegua SIZE 251,8 OF oDlg NOPERCENTAGE PIXEL

			nLinha := 82
			@ 82,015 BUTTON aButton[1] Prompt OemToAnsi("&Ocorrências") ACTION u_Y690ShowOCR() SIZE 44,11 OF oDlg PIXEL	//"&Ocorrˆncias"
			 DEFINE SBUTTON aButton[2] FROM nLinha,100 TYPE  1 ACTION (u_Y690Button(.F.), U_YA690Aloc(@aRet,@aRecursos,@lOk)	, u_Y690Button(.T.),If(mv_par29==1,oDlg:End(),)) ENABLE OF oDlg PIXEL
			DEFINE SBUTTON aButton[3] FROM nLinha,135 TYPE  5 ACTION (u_Y690Button(.F.), U_YAQuestion(.T.), u_Y690Button(.T.)) ENABLE OF oDlg PIXEL
			DEFINE SBUTTON aButton[4] FROM nLinha,170 TYPE 15 ACTION (u_Y690Button(.F.), lProcesPPI:=.T., U_YAVisual(), If(lReprocessa, U_YA690Aloc(@aRet,@aRecursos,@lOk),), u_Y690Button(.T.)) ENABLE OF oDlg PIXEL
			DEFINE SBUTTON aButton[5] FROM nLinha,205 TYPE  6 ACTION (u_Y690Button(.F.), u_Y690Relato(), u_Y690Button(.T.)) ENABLE OF oDlg PIXEL
			DEFINE SBUTTON aButton[6] FROM nLinha,240 TYPE  2 ACTION (oDlg:End()) ENABLE OF oDlg PIXEL

			ACTIVATE MSDIALOG oDlg CENTERED
			
		EndIf
	EndIf
	If Select("FER") > 0
		dbSelectArea("FER")
		dbCloseArea()
	EndIf

	If Select("CARGA") > 0
		dbSelectArea("CARGA")
		dbCloseArea()
	EndIf


    If lContinua
		ClosSemSH8()
	EndIf                                    
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Copia arquivos de processamento para diretorio dos dados               ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If cDirPCP != cDirDados .And. lOk
		U_YACopyFile()
	EndIf
	dbSelectArea("SC2")
EndIf
//Atencao: este return nunca podera ser informado com Nil, para nao
//gerar problemas com o scheduler(nao finalizando a conexao)
Return

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³u_Y690Button ³ Autor ³ Marcelo Iuspa        ³ Data ³29/08/2000³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Ativa/Desativa botoes enquanto processa                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ lAction : True->Ativa / False->Desativa                    ³±±
±±³          ³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAPCP       ³ Carga Maquina                              ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
User Function Y690Button(lAction)
aEval(aButton, If(lAction, {|_1| _1:Enable()}, {|_1| _1:Disable()}))
dDataBrowse := If(Type("dDataPar") = "D", dDataPar, dDataBase)
Return


/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ Y690SetUp2³ Autor ³ Ben-Hur M Castilho   ³ Data ³ 10/12/96 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Verifica se o Mesmo Produto Em Questao p/ Lancar ou Nao    ³±±
±±³          ³ Tempo de SetUp.                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
User Function Y690SetUp2( cOp,cProduto )
Local cAlias  := Alias(),;
	nRecord := 0,;
	nOrder  := 0

If (SC2->C2_FILIAL+SC2->C2_NUM+SC2->C2_ITEM+SC2->C2_SEQUEN+SC2->C2_ITEMGRD == xFilial( "SC2" )+cOP)
	lBack := !(SC2->C2_PRODUTO == cProduto)
Else
	dbSelectArea( "SC2" )
	nRecord := Recno()
	nOrder  := IndexOrd()
	dbSetOrder(1)
	If DbSeek( xFilial( "SC2" )+cOp,.F. )
		lBack := !(SC2->C2_PRODUTO == cProduto)
	Else
		lBack := .T.
	EndIf
	dbSetOrder(nOrder)
	dbGoTo(nRecord)
	dbSelectArea(cAlias)
EndIf
Return(lBack)

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³u_Y690SetUp2³ Autor ³ Ben-Hur M. Castilho   ³ Data ³          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Funcao que divide as alocacoes de acordo com a disponibili-³±±
±±³          ³ dade do calendario.                                        ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
User Function Y690SubDiv(cCal,nAtual,nDuracao,nStrLen,cCalCop)
Local aBack  := {}
Local nMinSz   := 0,;
	nBitUsed := 0,;
	nBitAloc := 0,;
	nBitRslt := 0
Local lLoop    := .T.,;
	lDoing   := .F.
Local nBackAtual:=nAtual
Local lMudaSoma:=.F.

If (nDuracao > 0) .And. ;
		((nMinSz := A690ChkAlc( cCalCop,nDuracao,nAtual,0,(nStrLen*8) )) > 0)
	While lLoop .And. (nMinSz > 0)
		nPosINI  := If((MV_PAR01 == 1),((nAtual-nMinSz)+1),nAtual)
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Ajusta Bit Inicial para alocacao pelo Fim em uma Alocacao  ³
		//³pelo Inicio (Situacao que ocorre quando h  sobreposicao em ³
		//³uma alocacao e a operacao a ser alocada nao ultrapassa a   ³
		//³operacao anterior, nao atinge o nBitLimit).                ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If lMudaPraFim .And. (MV_PAR01 == 1 )
			nPosINI -= If((nPosINI-1) > nMinSz,1,0)	
		EndIf
		nBitUsed := Look4Bit( cCal,nPosINI,nMinSz,nStrLen )
		If ((nMinSz-nBitUsed) == nDuracao)
			lLoop  := .F.
			lDoing := .T.
		Else
			If lMudaPraFim .And. nPosIni+nDuracao <= nBackAtual
				lMudaSoma:=.T.
			EndIf
			nAtual += If((MV_PAR01 == 1 .And. !lMudaSoma),(-1),1)
			nMinSz := A690ChkAlc( cCalCop,nDuracao,nAtual,nMinSz,(nStrLen*8) )
		EndIf
	EndDo
	If lDoing
		nPosINI  := If((MV_PAR01 == 1),((nAtual-nMinSz)+1),nAtual)
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Ajusta Bit Inicial para alocacao pelo Fim em uma Alocacao  ³
		//³pelo Inicio (Situacao que ocorre quando h  sobreposicao em ³
		//³uma alocacao e a operacao a ser alocada nao ultrapassa a   ³
		//³operacao anterior, nao atinge o nBitLimit).                ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If lMudaPraFim .And. (MV_PAR01 == 1 )
			nPosINI -= If((nPosINI-1) > nMinSz,1,0)	
		EndIf
		nPosATU  := nPosINI
		nBitUsed := 0
		While (nMinSz > 0) .And. lDoing
			nBitRslt := u_YBit2On( cCal,nPosATU,1,nStrLen )
			Do Case
			Case (nBitRslt == 1)
				If (nPosINI == 0)
					nPosINI := nPosATU
				EndIf
				nBitUsed++
				nBitAloc++
			Case (nBitRslt == 0)
				If (nPosINI >= 1) .And. (nBitUsed >= 1)
					aAdd( aBack,{ nPosINI,nBitUsed } )
				Endif
				nPosINI  := 0
				nBitUsed := 0
			OtherWise
				aBack  := {}
				lDoing := .F.
			EndCase
			nMinSz--
			nPosATU++
		EndDo
		If (nPosINI >= 1)
			aAdd( aBack,{ nPosINI,nBitUsed } )
		Endif
		If !(nBitAloc == nDuracao)
			aBack := {}
		EndIf
	EndIf
EndIf
Return(A690SubRet(aBack))

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³A690SubRet³ Autor ³ Ben-Hur M Castilho    ³ Data ³          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Ajusta o Retorno do Array aSubDiv, Conforme Selecao de     ³±±
±±³          ³ Carga Pelo Inicio Ou Fim                                   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function A690SubRet( aBack )
If (MV_PAR01 == 1)
	ASort( aBack,,,{ | aX,aY | aX[1] > aY[1] })
EndIf
Return(aBack)

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³A690ChkAlc³ Autor ³ Ben-Hur M Castilho    ³ Data ³          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Verifica o Espaco Minimo p/ a Alocacao de uma operacao e   ³±±
±±³          ³ impede alocacoes fragmentadas                              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function A690ChkAlc(cCalCop,nSize,nInicio,nValue,nLen,lOk)
Local nPosINI  := 0,;
	nAvail   := 0,;
	nMinSz   := If((nValue == 0),nSize,nValue),;
	lError   := .F.,;
	lTesting := .T.

If (nSize > 0)
	nPosINI := If((MV_PAR01 == 1),((nInicio-nMinSz)+1),nInicio)
	lError  := If((MV_PAR01 == 1),!(nPosINI >= 1 .And. nPosIni < nLen),!((nPosINI+nMinSz) <= nLen))
	While lTesting .And. !lError
		nAvail := (nMinSz-Look4Bit( cCalCop,nPosINI,nMinSz,(nLen/8) ))
		Do Case
		Case (nAvail == nSize)
			lTesting := .F.
		Case (nAvail >  nSize)
			nMinSz--
		OtherWise
			nMinSz++
		EndCase
		nPosINI := If((MV_PAR01 == 1),((nInicio-nMinSz)+1),nInicio)
		lError  := If((MV_PAR01 == 1),!(nPosINI >= 1 .And. nPosIni < nLen),!((nPosINI+nMinSz) <= nLen))
	EndDo
EndIf
Return(If(lError,0,nMinSz))

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³u_Y690FerrDisp³ Autor ³ Ricardo Dutra       ³ Data ³ 02/09/93 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna o registro e bit da ferramenta disponivel p/ aloc. ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ ExpA1=u_Y690FerrDisp(ExpC1,ExpN2,ExpN3,ExpN4)                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpA1 = Retorno:                                           ³±±
±±³          ³      ExpA1[1] = numero do registro disponivel, 0 nao disp. ³±±
±±³          ³      ExpA1[2] = primeiro bit disponivel                    ³±±
±±³          ³ ExpC1 = Codigo da ferramenta a ser pesquisada              ³±±
±±³			 ³ ExpN1 = Inicio do periodo a ser pesquisado				     ³±±
±±³			 ³ ExpN2 = Numero de unidades de alocacao (15 min) a pesquisar³±±
±±³			 ³ ExpN3 = Modo de Alocacao (1 - inicio , 0 - fim)            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAPCP                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
User Function Y690FerrDisp(cFerr,nIni,nUnid,cUltFerr,aRet,cCalcOP)
LOCAL cBuffer			// buffer para leitura de arquivo binario
LOCAL i					// contador auxiliar
LOCAL k					// contador auxiliar
LOCAL lOk				// inresultado do teste do registro em relacao ao periodo de alocacao
LOCAL aRegs := {}		// array com o primeiro e ultimo registros da ferramenta
LOCAL nBitAtu			// bit atual de alocacao
LOCAL nBitDisp			// primeiro bit disponivel para alocacao
LOCAl nReg				// registro escolhido para alocacao
LOCAL aRetorno := {}	// array de retorno
LOCAL aRetDisp := {}
Local nUltFerr, nFirst := 0
Local nH4Recno := SH4->(RecNo())

If ! SH4->(dbSeek(xFilial("SH4") + cFerr)) .Or. SH4->H4_QUANT == 0
	SH4->(dbGoto(nH4Recno))
	Return({0, 0})
Endif
SH4->(dbGoto(nH4Recno))

aRetorno := Array(2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Obtem o primeiro e ultimo registro da ferramenta       ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
aRegs := u_YFerrRegs(cFerr,aRet)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ VerIfica a disponibilidade da ferramenta para o periodo³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
lOk := .F.
cBuffer := Space(aRet[4])         // com o tamanho do periodo total
nBitAtu := If(mv_par01 = 1 , 0 , aRet[4]*8)      // bit final do periodo
nReg     := 0 	// indica estouro do calendario

// Alterado para que a ferramenta utilizada seja a mesma utilizada na ultima
// operacao (se aquela estiver entre as melhores opcoes).
nUltFerr := Val(Substr(cUltFerr,7,6))
If cFerr == Substr(cUltFerr,1,6) .And. ( nUltFerr >= aRegs[1] .Or. nUltFerr <= aRegs[2] )
	nFirst := nUltFerr
EndIf

For i:= aRegs[1] TO aRegs[2]		// para cada registro da ferramenta

	If nFirst # 0
		If i == aRegs[1]
			k := nFirst
		ElseIf i == nFirst
			k := aRegs[1]
		Else
			k := i
		EndIf
	Else
		k := i
	EndIf

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Le o registro atual da ferramenta                      ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	FSeek(aRet[6],(k - 1) * aRet[4],0)	// o arquivo e contado a partir de zero
	If FRead(aRet[6],@cBuffer,aRet[4]) # aRet[4] .And. !lShowOCR .And. aRet[8] > 0
		cBuffer := Pad(cBuffer, aRet[4])
		Help(" ",1,"FREADERROR",,Str(FError(),2,0),05,38)
	EndIf

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Se estiver disponivel, sai, senao procura o proximo bit ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If u_YBit2On(cBuffer,nIni,nUnid,aRet[4]) == 1
		lOk     := .T.
		nReg    := k
		nBitAtu := nIni
		Exit
	Else
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Se nao estiver disponivel no periodo desejado, procura o³
		//³ proximo bit disponivel                                  ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If mv_par01 == 1
			nBitDisp := U_YNeBitFree(cBuffer,nIni+nUnid-1,aRet)
		Else
			//nBitDisp := U_YNeBitFree(cBuffer,nIni,aRet)
			aRetDisp := U_Y690SubDiv(cBuffer,nIni,nUnid,aRet[4],cCalcOP)
			If Empty(aRetDisp)
				nBitDisp := -1
			Else
				nBitDisp := aRetDisp[1,1]
				If TRB->TPALOCF=="2" .AND. !Empty(TRB->SETUP) .AND. u_YBit2On(cBuffer,nBitDisp,nUnid-U_YTempo2Bit(TRB->SETUP),aRet[4]) == 1								
					nBitDisp -= u_YASetupG()
				EndIf
			EndIf
		EndIf
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Avalia se a ferramenta esta totalmente disponivel, se nao estiver ³
		//³ busca proximo espaco vazio, hoje o programa ainda nao sub-divide  ³
		//³ a operacao de acordo com a disponibilidade da ferramenta.         ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		/*
		aFerSubDiv := u_Y690SubDiv(cBuffer, nBitDisp, nUnid, aRet[4],cCalcOP)
		If Empty(aFerSubDiv)
			nBitDisp := -1
		ElseIf aFerSubDiv[1][2] < nUnid
			nBitDisp := -1
			While .T.
				nBitDisp := aFerSubDiv[Len(aFerSubDiv)][1]+aFerSubDiv[Len(aFerSubDiv)][2]-1
				aFerSubDiv := u_Y690SubDiv(cBuffer, nBitDisp, nUnid, aRet[4],cCalcOP)
				If Empty(aFerSubDiv)
					nBitDisp := -1
					Exit
				EndIf
				If aFerSubDiv[1][2] == nUnid
					Exit
				EndIf
			End
		EndIf
        */
		If nBitDisp # -1
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ VerIfica se o primeiro bit disponivel e'melhor que o bit³
			//³ atualmente escolhido de acordo com o modo de alocacao   ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If mv_par01 = 1
				If nBitDisp > nBitAtu
					nBitAtu := nBitDisp
					nReg    := k
				Endif
			Else
				If nBitDisp < nBitAtu
					nBitAtu := nBitDisp
					nReg    := k
				Endif
			Endif
		Endif
	Endif
Next

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Compoe o array de retorno: {registro escolhido,bit disponivel}  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
aRetorno[1] := nReg
aRetorno[2] := nBitAtu
Return aRetorno

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³u_YFerrRegs³ Autor ³ Ricardo Dutra       ³ Data ³ 13/09/93 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna array com o 1o. e ultimo registro da ferramenta    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ ExpA1=u_YFerrRegs(ExpC1)                                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpA1 = ExpA1[1] - primeiro registro                       ³±±
±±³          ³         ExpA1[2] - ultimo registro                         ³±±
±±³			 ³ ExpC1 = Ferramenta                                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAPCP                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
User Function YFerrRegs(cFerram,aRet)
LOCAL cBuffer 		// string para leitura do arquivo de indice
LOCAL nPosicao		// posicao da ferramenta no arquivo de indice
LOCAL nPI			// posicao do 1o. byte com o valor da posicao do registro da ferr. desejada
LOCAL aRegFerr 		// array de retorno

aRegFerr := Array(2)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Le o aruivo de indice de ferramentas                   ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
cBuffer := Space(aRet[8] * 11)
FSeek(aRet[7],0,0)
If FRead(aRet[7],@cBuffer,aRet[8] * 11) # ( aRet[8] * 11 ) .And. !lShowOCR
	Help(" ",1,"FREADERROR",,Str(FError(),2,0),05,38)
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Localiza o primeiro registro da ferramenta             ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nPosicao:= At(cFerram,cBuffer)
nPI := aRet[8] * 7 + 1
nPI := nPI + ( ( ( nPosicao - 1 ) / 7 ) * 4 )
aRegFerr[1] := Bin2I(Substr(cBuffer,nPI,2))
aRegFerr[2] := Bin2I(Substr(cBuffer,nPI+2,2))

Return aRegFerr

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³A690FerrAloc³ Autor ³ Ricardo Dutra       ³ Data ³ 02/09/93 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Aloca/Desaloca a ferramenta no periodo desejado            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ A690FerrAloc(ExpC1,ExpN1,ExpN2,ExpN3,ExpL1)                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpC1 = Codigo da ferramenta a ser alocada/desalocado      ³±±
±±³			 ³ ExpN1 = Inicio do periodo a ser alocado/desalocado 		  ³±±
±±³			 ³ ExpN2 = Fim do periodo a ser alocado/desalocado            ³±±
±±³			 ³ ExpN3 = Registro do arquivo de ferramenta a ser alocado    ³±±
±±³			 ³ ExpL1 = Define o modo de atualizacao: .T. - aloca		     ³±±
±±³			 ³                                    	  .F. - desaloca       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAPCP                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function A690FerrAloc(cFerram,nIni,nUnid,nReg,lAloc,aRet)

LOCAL nByteIni						// byte inicial do registro a atualizar
LOCAL cBuffer						// buffer para leitura do arquivo binario

cBuffer := Space(aRet[4])			// numero de bytes necessarios para periodo

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Calcula o byte inicial do registro para alocacao       ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nByteIni := (nReg-1) * aRet[4]

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Posiciona a arquivo para ler o registro disponivel     ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
FSeek(aRet[6],nByteIni,0)			// posiciona o arquivo para ler
If FRead(aRet[6],@cBuffer,aRet[4]) # aRet[4] .And. !lShowOCR		// le o registro de alocacao de ferramenta
	Help(" ",1,"FREADERROR",,Str(FError(),2,0),05,38)
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Se for alocar,set os bits correspondentes,senao reseta ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If lAloc
	StuffBit(@cBuffer,nIni,nUnid,aRet[4])		// aloca os bits corespondentes
Else
	YUnStuff2(@cBuffer,nIni,nUnid,aRet[4])		// desaloca os bits correspondentes
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Grava os bits atualizados no arquivo de ferramenta     ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
FSeek(aRet[6],nByteIni,0)			// posiciona o arquivo para gravar
If FWrite(aRet[6],cBuffer,aRet[4]) < aRet[4] .And. !lShowOCR
	Help(" ",1,"FWRITERROR",,Str(FError(),2,0),05,38)
EndIf
Return

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³u_Y690ShowOCR³ Autor ³ Ary Medeiros         ³ Data ³          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Revis„o  ³ Waldemiro L. Lustosa                     ³ Data ³ 13/09/95 ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
User Function Y690ShowOCR()
Local cFile, cString
Local cAlias := Alias()
Local i,aOcorr:={}
Local oDlg,oOcorr
Local lExibeOcor := .T.
Local nHdl
Local nHandle

cFile := cDirPcp+cNameCarga+".OCR"
nHdl  := fOpen(cFile,2+64)

If ExistBlock("A690OCOR")
	lExibeOcor := ExecBlock("A690OCOR", .F., .F., cFile)
	If ValType(lExibeOcor) == "L" .And. ! lExibeOcor
		Return Nil
	Endif
Endif		

If !File(cFile)
	cString := OemToAnsi("Nenhuma ocorrˆncia encontrada ...")	//"Nenhuma ocorrˆncia encontrada ..."
	AADD(aOcorr,cString+Space(63-Len(cString)))
Else
	//Abre o arquivo
	nHandle := FT_FUse(cFile)
	
	//Se não houver erro de abertura busca as linhas 
	If nHandle != -1  
		//Posiciona na primeria linha 
		FT_FGoTop()
		
		//Percorre o arquivo
		While !FT_FEOF()
   			//Retorna a linha corrente
   			cString  := FT_FReadLn() 
   			
   			//Insere no array
   			AADD(aOcorr,OemToAnsi(cString))    
   			   
   			//Pula para próxima linha  
   			FT_FSKIP()
		End
	
		//Fecha o Arquivo
		FT_FUSE()
	EndIf
EndIf

If Len(aOcorr) > 0
	DEFINE MSDIALOG oDlg TITLE OemToAnsi("Ocorrências") From 8,05 To 20,65 OF oMainWnd	//"Ocorrˆncias"
	@ 1,001 LISTBOX oOcorr Fields HEADER Space(63) SIZE 190,70
	oOcorr:SetArray(aOcorr)
	oOcorr:bLine := { || {aOcorr[oOcorr:nAT]} }
	DEFINE SBUTTON FROM 18,202 TYPE 1 ACTION oDlg:End() ENABLE OF oDlg
	DEFINE SBUTTON FROM 31,202 TYPE 6 ACTION (U_YAImpOcorr(aOcorr),oDlg:End()) ENABLE OF oDlg
	ACTIVATE MSDIALOG oDlg
EndIf
fClose(nHdl)
Return NIL

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³u_Y690AtuSH8  ³ Autor ³ Waldemiro Lustosa   ³ Data ³ 14/09/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Funcao de gravacao do SH8 - Operacoes Alocadas.            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ u_Y690AtuSH8(EC1,EA1,EA2,EN1,EN2,EN3,EN4,EN5,EN6,EN7)        ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpC1 = 01.Codigo do Recurso                               ³±±
±±³          ³ ExpA1 = 02.Array com a Data e Hora Inicial da Alocacao     ³±±
±±³          ³ ExpA2 = 03.Array com a Data e Hora Final da Alocacao       ³±±
±±³          ³ ExpN1 = 04.Bit Inicial da Alocacao                         ³±±
±±³          ³ ExpN2 = 05.Bit Final da Alocacao                           ³±±
±±³          ³ ExpN3 = 06.Qtde de Desdobramento                           ³±±
±±³          ³ ExpN4 = 07.Numeros dos Desdobramentos                      ³±±
±±³          ³ ExpN5 = 08.Bits Usados na Operacao                         ³±±
±±³          ³ ExpN6 = 09.Posicao em Arquivo Binario                      ³±±
±±³          ³ ExpN7 = 10.Quantidade a Produzir 						  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
User Function Y690AtuSH8(cRecurso, aDtHrIni, aDtHrFim, nInicio, nFim, nNumDes, nSubDiv, nDurDesdob, nIndSubDiv,nQuant, nSetup,nTempEnd)
Local cAlias := Alias(), nIndexOrd := IndexOrd()
Local cABC   := "ABCDEFGHIJKLMNOPQRSTUVWXYZ"
Local nRecTRB, cOpAnt, nRecSH8, nRecCARGA
Local nPosDepend := 0
Local lMT690GSH8 := ExistBlock("MT690GSH8")      
Local cNCTRAB    := Nil
Local nTamNumOP  := TamSX3("C2_NUM")[1]
Local nTamItemOP := TamSX3("C2_ITEM")[1]
Local nTamSeqOP  := TamSX3("C2_SEQUEN")[1]
Local nTamIGrdOP := TamSX3("C2_ITEMGRD")[1]


Default nSetup  := 0
Default nTempEnd:= 0

nIndSubDiv := IIf( nIndSubDiv == NIL, 0, nIndSubDiv )

If (nPosDepend := aScan(aRecDepend, {|x| x[1] == TRB->OPNUM+TRB->ITEM+TRB->SEQUEN+TRB->ITEMGRD})) == 0
	Aadd(aRecDepend, {TRB->OPNUM+TRB->ITEM+TRB->SEQUEN+TRB->ITEMGRD, cRecurso, u_Y690RecLin(cRecurso), TRB->TPLINHA})
Else
	aRecDepend[nPosDepend, 4] := TRB->TPLINHA
Endif             

cNCTRAB := u_Y690CarregaCT(cRecurso)
if Empty(cNCTRAB)
	cNCTRAB := TRB->CTRAB
EndIf

dbSelectArea("SH8")
dbAppend()
Replace H8_FILIAL 	With xFilial("SH8")
Replace H8_OP 		With TRB->OPNUM+TRB->ITEM+TRB->SEQUEN+TRB->ITEMGRD
Replace H8_OPER 	With TRB->OPERAC
Replace H8_RECURSO 	With cRecurso
Replace H8_FERRAM 	With TRB->FERRAM
Replace H8_DTINI 	With aDtHrIni[1]
Replace H8_HRINI 	With aDtHrIni[2]
Replace H8_DTFIM 	With aDtHrFim[1]
Replace H8_HRFIM 	With aDtHrFim[2]
Replace H8_BITINI 	With nInicio
Replace H8_BITFIM 	With nFim
Replace H8_SEQPAI 	With TRB->SEQPAI
Replace H8_QUANT 	With nQuant
Replace H8_DESDOBR 	With IIf( nSubDiv == 0, StrZero(nNumDes,3), StrZero(nNumDes,3)+Substr(cABC,nSubDiv,1) )
Replace H8_BITUSO 	With nDurDesdob
Replace H8_SUBDIV 	With nIndSubDiv
Replace H8_CTRAB 	With cNCTRAB
Replace H8_ROTEIRO 	With TRB->CODIGO
Replace H8_SEQROTA 	With TRB->SEQROTA
Replace H8_SEQCARG  With cSeqCarga
Replace H8_SETUP    With nSetup
Replace H8_TEMPEND  With nTempEnd

//FAZER AQUI A GRAVAÇÃO DO SZK
dbSelectArea("SZK")
dbAppend()
Replace ZK_FILIAL 	With xFilial("SH8")
Replace ZK_OP 		With TRB->OPNUM+TRB->ITEM+TRB->SEQUEN+TRB->ITEMGRD
Replace ZK_OPER 	With TRB->OPERAC
Replace ZK_RECURSO 	With cRecurso
Replace ZK_FERRAM 	With TRB->FERRAM
Replace ZK_DTINI 	With aDtHrIni[1]
Replace ZK_HRINI 	With aDtHrIni[2]
Replace ZK_DTFIM 	With aDtHrFim[1]
Replace ZK_HRFIM 	With aDtHrFim[2]
Replace ZK_BITINI 	With nInicio
Replace ZK_BITFIM 	With nFim
Replace ZK_SEQPAI 	With TRB->SEQPAI
Replace ZK_QUANT 	With nQuant
Replace ZK_DESDOBR 	With IIf( nSubDiv == 0, StrZero(nNumDes,3), StrZero(nNumDes,3)+Substr(cABC,nSubDiv,1) )
Replace ZK_BITUSO 	With nDurDesdob
Replace ZK_SUBDIV 	With nIndSubDiv
Replace ZK_CTRAB 	With cNCTRAB
Replace ZK_ROTEIRO 	With TRB->CODIGO
Replace ZK_SEQROTA 	With TRB->SEQROTA
Replace ZK_SEQCARG  With cSeqCarga
Replace ZK_SETUP    With nSetup
Replace ZK_TEMPEND  With nTempEnd
dbSelectArea("SH8")



cNCTRAB := u_Y690CarregaCT(cRecurso)
if Empty(cNCTRAB)
	cNCTRAB := TRB->CTRAB
EndIf

dbSelectArea("CARGA")
dbAppend()
Replace H8_FILIAL 	With xFilial("SH8")
Replace H8_OP 		With TRB->OPNUM+TRB->ITEM+TRB->SEQUEN+TRB->ITEMGRD
Replace H8_OPER 	With TRB->OPERAC
Replace H8_RECURSO 	With cRecurso
Replace H8_FERRAM 	With TRB->FERRAM
Replace H8_DTINI 	With aDtHrIni[1]
Replace H8_HRINI 	With aDtHrIni[2]
Replace H8_DTFIM 	With aDtHrFim[1]
Replace H8_HRFIM 	With aDtHrFim[2]
Replace H8_BITINI 	With nInicio
Replace H8_BITFIM 	With nFim
Replace H8_SEQPAI 	With TRB->SEQPAI
Replace H8_QUANT 	With TRB->QTDPROD
Replace H8_DESDOBR 	With IIf( nSubDiv == 0, StrZero(nNumDes,3), StrZero(nNumDes,3)+Substr(cABC,nSubDiv,1) )
Replace H8_BITUSO 	With nDurDesdob
Replace H8_SUBDIV 	With nIndSubDiv
Replace H8_CTRAB 	With cNCTRAB
Replace H8_ROTEIRO 	With TRB->CODIGO
Replace H8_SEQROTA 	With TRB->SEQROTA
Replace H8_SEQCARG  With cSeqCarga
Replace H8_SETUP    With nSetup
Replace H8_TEMPEND  With nTempEnd
Replace H8_OPIT With SubStr(H8_OP,1,nTamNumOP+nTamItemOP)
Replace H8_OPIGRD With Substr(H8_OP,nTamNumOP+nTamItemOP+nTamSeqOP+1,nTamIGrdOP)

dbSelectArea("TRB")
Replace OPERALOC With .T.

If lMT690GSH8
	ExecBlock("MT690GSH8",.F.,.F.)
EndIf	

If lMaqXQuant
	If TRB->QTDALOC != 0
		nRecTRB  := RecNo()
		cOpAnt   := TRB->OPAGLUT
		nRecSH8  := SH8->(RecNo())
		nRecCARGA:= CARGA->(RecNo())
		dbSkip()
		While !Eof()
			If cOpAnt == TRB->OPAGLUT .And. !Empty(cOpAnt)
				Replace TRB->RECURSO  With cRecurso
				Replace TRB->RECAGLUT With cRecurso
				Replace TRB->OPERALOC With .T. 
				
				cNCTRAB := u_Y690CarregaCT(cRecurso)
				if Empty(cNCTRAB)
					cNCTRAB := TRB->CTRAB
				EndIf

				dbSelectArea("SH8")
				dbAppend()
				Replace H8_FILIAL 	With xFilial("SH8")
				Replace H8_OP 		With TRB->OPNUM+TRB->ITEM+TRB->SEQUEN+TRB->ITEMGRD
				Replace H8_OPER 	With TRB->OPERAC
				Replace H8_RECURSO 	With cRecurso
				Replace H8_FERRAM 	With TRB->FERRAM
				Replace H8_DTINI 	With aDtHrIni[1]
				Replace H8_HRINI 	With aDtHrIni[2]
				Replace H8_DTFIM 	With aDtHrFim[1]
				Replace H8_HRFIM 	With aDtHrFim[2]
				Replace H8_BITINI 	With nInicio
				Replace H8_BITFIM 	With nFim
				Replace H8_SEQPAI 	With TRB->SEQPAI
				Replace H8_QUANT 	With TRB->QTDPROD
				Replace H8_DESDOBR 	With IIf( nSubDiv == 0, StrZero(nNumDes,3), StrZero(nNumDes,3)+Substr(cABC,nSubDiv,1) )
				Replace H8_BITUSO 	With nDurDesdob
				Replace H8_SUBDIV 	With nIndSubDiv
				Replace H8_CTRAB 	With cNCTRAB
				Replace H8_ROTEIRO 	With TRB->CODIGO
				Replace H8_SEQROTA 	With TRB->SEQROTA
				Replace H8_SEQCARG  With cSeqCarga
				Replace H8_SETUP    With nSetup
				Replace H8_TEMPEND  With nTempEnd
				
				//FAZER AQUI A GRAVAÇÃO DO SZK
				dbSelectArea("SZK")
				dbAppend()
				Replace ZK_FILIAL 	With xFilial("SH8")
				Replace ZK_OP 		With TRB->OPNUM+TRB->ITEM+TRB->SEQUEN+TRB->ITEMGRD
				Replace ZK_OPER 	With TRB->OPERAC
				Replace ZK_RECURSO 	With cRecurso
				Replace ZK_FERRAM 	With TRB->FERRAM
				Replace ZK_DTINI 	With aDtHrIni[1]
				Replace ZK_HRINI 	With aDtHrIni[2]
				Replace ZK_DTFIM 	With aDtHrFim[1]
				Replace ZK_HRFIM 	With aDtHrFim[2]
				Replace ZK_BITINI 	With nInicio
				Replace ZK_BITFIM 	With nFim
				Replace ZK_SEQPAI 	With TRB->SEQPAI
				Replace ZK_QUANT 	With nQuant
				Replace ZK_DESDOBR 	With IIf( nSubDiv == 0, StrZero(nNumDes,3), StrZero(nNumDes,3)+Substr(cABC,nSubDiv,1) )
				Replace ZK_BITUSO 	With nDurDesdob
				Replace ZK_SUBDIV 	With nIndSubDiv
				Replace ZK_CTRAB 	With cNCTRAB
				Replace ZK_ROTEIRO 	With TRB->CODIGO
				Replace ZK_SEQROTA 	With TRB->SEQROTA
				Replace ZK_SEQCARG  With cSeqCarga
				Replace ZK_SETUP    With nSetup
				Replace ZK_TEMPEND  With nTempEnd
				dbSelectArea("SH8")


				cNCTRAB := u_Y690CarregaCT(cRecurso)
				if Empty(cNCTRAB)
					cNCTRAB := TRB->CTRAB
				EndIf
				
				dbSelectArea("CARGA")
				dbAppend()
				Replace H8_FILIAL 	With xFilial("SH8")
				Replace H8_OP 		With TRB->OPNUM+TRB->ITEM+TRB->SEQUEN+TRB->ITEMGRD
				Replace H8_OPER 	With TRB->OPERAC
				Replace H8_RECURSO 	With cRecurso
				Replace H8_FERRAM 	With TRB->FERRAM
				Replace H8_DTINI 	With aDtHrIni[1]
				Replace H8_HRINI 	With aDtHrIni[2]
				Replace H8_DTFIM 	With aDtHrFim[1]
				Replace H8_HRFIM 	With aDtHrFim[2]
				Replace H8_BITINI 	With nInicio
				Replace H8_BITFIM 	With nFim
				Replace H8_SEQPAI 	With TRB->SEQPAI
				Replace H8_QUANT 	With TRB->QTDPROD
				Replace H8_DESDOBR 	With IIf( nSubDiv == 0, StrZero(nNumDes,3), StrZero(nNumDes,3)+Substr(cABC,nSubDiv,1) )
				Replace H8_BITUSO 	With nDurDesdob
				Replace H8_SUBDIV 	With nIndSubDiv
				Replace H8_CTRAB 	With cNCTRAB
				Replace H8_ROTEIRO 	With TRB->CODIGO
				Replace H8_SEQROTA 	With TRB->SEQROTA
				Replace H8_SEQCARG  With cSeqCarga
				Replace H8_SETUP    With nSetup
				Replace H8_TEMPEND  With nTempEnd
				Replace H8_OPIT With SubStr(H8_OP,1,nTamNumOP+nTamItemOP)
				Replace H8_OPIGRD With Substr(H8_OP,nTamNumOP+nTamItemOP+nTamSeqOP+1,nTamIGrdOP)

				dbSelectArea("TRB")
				nRecTRB  := RecNo()
			Else
				Exit
			Endif
			dbSelectArea("TRB")
			dbSkip()
		End
		dbGoto(nRecTRB)
		SH8->(dbGoto(nRecSH8))
		CARGA->(dbGoto(nRecCARGA))
	Endif
Endif
dbSelectArea(cAlias)
dbSetOrder(nIndexOrd)
Return NIL

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³A690FilSC2  ³ Autor ³ Waldemiro Lustosa   ³ Data ³ 20/09/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Condicao para IndRegua do SC2.                             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
User Function Y690FilSC2()
Local xRet
Local cNumDe:=Substr(mv_par09,1,Len(SC2->C2_NUM))
Local cIteDe:=Substr(mv_par09,Len(SC2->C2_NUM)+1,Len(SC2->C2_ITEM))
Local cSeqDe:=Substr(mv_par09,Len(SC2->C2_NUM)+Len(SC2->C2_ITEM)+1,Len(SC2->C2_SEQUEN))
Local cNumAte:=Substr(mv_par10,1,Len(SC2->C2_NUM))
Local cIteAte:=Substr(mv_par10,Len(SC2->C2_NUM)+1,Len(SC2->C2_ITEM))
Local cSeqAte:=Substr(mv_par10,Len(SC2->C2_NUM)+Len(SC2->C2_ITEM)+1,Len(SC2->C2_SEQUEN))
Local cTipoOp:=IF(mv_par21==1," F",IF(mv_par21==2,"P"," FP"))
Local cItGrDe := Right(mv_par09,Len(SC2->C2_ITEMGRD))
Local cItGrAte:= Right(mv_par10,Len(SC2->C2_ITEMGRD))
Local cStatus:=If(mv_par05==1,"N ","NS ")
xRet := 'DTOS(C2_DATRF) == "'+Space(08)+'"'
xRet += '.And.C2_QUJE+C2_PERDA < C2_QUANT .And. C2_STATUS $ "'+cStatus+'"'
xRet += '.And.DTOS(C2_DATPRF) >= "'+DTOS(mv_par07)+'" .And. DTOS(C2_DATPRF) <= "'+DTOS(mv_par08)+'"'
xRet += '.And.C2_NUM+C2_ITEM+C2_SEQUEN+C2_ITEMGRD >= "' + cNumDe +cIteDe +cSeqDe +cItGrDe  + '"'
xRet += '.And.C2_NUM+C2_ITEM+C2_SEQUEN+C2_ITEMGRD <= "' + cNumAte+cIteAte+cSeqAte+cItGrAte + '"'
xRet += '.And.C2_PRODUTO >= "'+mv_par11+'" .And. C2_PRODUTO <= "'+mv_par12+'" .And. C2_TPOP $ "'+cTipoOp+'"'
If ExistBlock("A690FSC2")
	cRetBlock := ExecBlock("A690FSC2",.F.,.F.,xRet)
	If ValType(cRetBlock) == "C"
		xRet := cRetBlock
	EndIf
EndIf
Return xRet

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³Y690SobrIni ³ Autor ³ Waldemiro Lustosa   ³ Data ³ 24/09/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Calcula Bit Ideal para Alocacao de uma Operacao pelo Inicio³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
User Function Y690SobrIni(cChaveSH8,nTempSob,cTpSobre,aRet)
Local i, aRecAloc := {}, cString, cCalStr, nHora, nInicio, nFim
Local cCalend, nAscan, nBitIni, nBitFim, lFirst := .T., nRet := -99999
Local nPecasBit, nBitSobr, nDurTotal, nQuantProd, cRecurso

dbSelectArea("CARGA")
dbSetOrder(1)
dbSeek(xFilial("SH8")+cChaveSH8)
If !Found()
	Return nRet
EndIf

While !Eof() .And. xFilial("SH8")+cChaveSH8 == H8_FILIAL+H8_OP+H8_OPER
	nAscan := Ascan( aRecAloc, { |x| x[1] == H8_RECURSO } )
	If nAscan == 0
		cString := Space(aRet[4])
		cCalStr := Space(aRet[4])
		cRecurso := H8_RECURSO
		FSeek(aRet[5],PosiMaq(cRecurso,aRet[2])*aRet[4])
		If FRead(aRet[5],@cString,aRet[4]) # aRet[4] .And. !lShowOCR
			Help(" ",1,"FREADERROR",,Str(FError(),2,0),05,38)
		EndIf
		FSeek(aRet[5],PosiMaq(cRecurso,aRet[2])*aRet[4])
		If FRead(aRet[5],@cCalStr,aRet[4]) # aRet[4] .And. !lShowOCR
			Help(" ",1,"FREADERROR",,Str(FError(),2,0),05,38)
		EndIf
		Aadd( aRecAloc, { cRecurso, cString, cCalStr, NIL, NIL, 0, H8_QUANT})
		nAscan := Len( aRecAloc )
	EndIf

	nHora := Val(Substr(H8_HRINI,1,2)+"."+Substr(H8_HRINI,4,2))
	nInicio:= DtHr2Bit(H8_DTINI,nHora)
	If nInicio < 1
		nInicio := 1
	Endif
	nHora := Val(Substr(H8_HRFIM,1,2)+"."+Substr(H8_HRFIM,4,2))
	nFim := DtHr2Bit(H8_DTFIM,nHora)
	If nFim < 1
		nFim := 1
	EndIf
	cCalend := aRecAloc[ nAscan ][2]
	StuffBit(@cCalend,nInicio,nFim-nInicio,aRet[4])
	aRecAloc[ nAscan ][2] := cCalend
	If aRecAloc[ nAscan ][4] == NIL
		aRecAloc[ nAscan ][4] := nInicio
	ElseIf aRecAloc[ nAscan ][4] > nInicio
		aRecAloc[ nAscan ][4] := nInicio
	EndIf
	If aRecAloc[ nAscan ][5] == NIL
		aRecAloc[ nAscan ][5] := nFim
	ElseIf aRecAloc[ nAscan ][5] < nFim
		aRecAloc[ nAscan ][5] := nFim
	EndIf
	aRecAloc[ nAscan ][6] += H8_BITUSO
	dbSkip()
End

If !Empty( aRecAloc )

	If nTempSob > 0

		nQuantProd := aRecAloc[1][7]
		nDurTotal := 0

		If Len( aRecAloc ) == 1
			nDurTotal := aRecAloc[1][6]
			nBitLimit := aRecAloc[1][5]
		Else
			For i := 1 to Len( aRecAloc )
				nDurTotal += aRecAloc[i][6]
				nBitLimit := IIf( aRecAloc[i][5] > nBitLimit, aRecAloc[i][5], nBitLimit )
			Next i
		EndIf

		nPecasBit := nQuantProd / nDurTotal

		nBit1Peca := Int( 1 / nPecasBit )+IIf( ( ( 1 / nPecasBit ) - Int( 1 / nPecasBit ) ) > 0, 1, 0)

		If cTpSobre == "1"
			nBitSobr := Int( nTempSob / nPecasBit )
		ElseIf cTpSobre == "2"
//		nBitSobr := NoRound( ( nDurTotal * nTempSob ) / 100 ,0)
			nBitSobr := NoRound( ( nDurTotal * nTempSob ) ,0)
		ElseIf cTpSobre == "3" .Or. cTpSobre == " "
			nBitSobr := U_YTempo2Bit( nTempSob )
		EndIf

		If Len( aRecAloc ) == 1
			nRet := A690BitPosition(aRecAloc[1][2], aRecAloc[1][3], nBitSobr, aRecAloc[1][4], aRecAloc[1][5],aRet)
		Else
			nRet := A690Bit2Position(aRecAloc,nBitSobr,aRet,IIf(cTpSobre=="1",.T.,.F.))
		EndIf

	Else
		nRet := aRet[4] * 8
		For i := 1 to Len( aRecAloc )
			nRet := IIf( aRecAloc[i][4] < nRet, aRecAloc[i][4], nRet )
		Next i
	EndIf

EndIf  

Return nRet
/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³A690SobrFim ³ Autor ³ Waldemiro Lustosa   ³ Data ³ 02/10/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Calcula Bit Ideal para Alocacao de uma Operacao pelo Fim   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
User Function YSobrFim(cOp,cOper,aRet,nRecTRB)
Local i, aRecAloc := {}, cString, cCalStr, nHora, nInicio, nFim
Local cCalend, cRecurso, nAscan, nBitIni, nBitFim, lFirst := .T., nRet := -99999
Local nPecasBit, nBitSobr, nDurTotal, nQuantProd, nRecAntTRB, nBitUtil := 0
Local aTest := {}
Local cString2, cCalStr2, nBitLiv, nBitAva

dbSelectArea("CARGA")
dbSetOrder(1)
dbSeek(xFilial("SH8")+cOp+cOper)
If !Found()
	Return nRet
EndIf

While !Eof() .And. xFilial("SH8")+cOp+cOper == H8_FILIAL+H8_OP+H8_OPER
	nAscan := Ascan( aRecAloc, { |x| x[1] == H8_RECURSO } )
	If nAscan == 0
		cString := Space(aRet[4])
		cCalStr := Space(aRet[4])
		FSeek(aRet[5],PosiMaq(H8_RECURSO,aRet[2])*aRet[4])
		If FRead(aRet[5],@cString,aRet[4]) # aRet[4] .And. !lShowOCR
			Help(" ",1,"FREADERROR",,Str(FError(),2,0),05,38)
		EndIf
		FSeek(aRet[5],PosiMaq(H8_RECURSO,aRet[2])*aRet[4])
		If FRead(aRet[5],@cCalStr,aRet[4]) # aRet[4] .And. !lShowOCR
			Help(" ",1,"FREADERROR",,Str(FError(),2,0),05,38)
		EndIf
		Aadd( aRecAloc, { H8_RECURSO, cString, cCalStr, NIL, NIL, 0, H8_QUANT})
		nAscan := Len( aRecAloc )
	EndIf

	nHora := Val(Substr(H8_HRINI,1,2)+"."+Substr(H8_HRINI,4,2))
	nInicio:= DtHr2Bit(H8_DTINI,nHora)
	If nInicio < 1
		nInicio := 1
	Endif
	nHora := Val(Substr(H8_HRFIM,1,2)+"."+Substr(H8_HRFIM,4,2))
	nFim := DtHr2Bit(H8_DTFIM,nHora)
	If nFim < 1
		nFim := 1
	EndIf
	cCalend := aRecAloc[ nAscan ][2]
	StuffBit(@cCalend,nInicio,nFim-nInicio,aRet[4])
	aRecAloc[ nAscan ][2] := cCalend
	If aRecAloc[ nAscan ][4] == NIL
		aRecAloc[ nAscan ][4] := nInicio
	ElseIf aRecAloc[ nAscan ][4] > nInicio
		aRecAloc[ nAscan ][4] := nInicio
	EndIf
	If aRecAloc[ nAscan ][5] == NIL
		aRecAloc[ nAscan ][5] := nFim
	ElseIf aRecAloc[ nAscan ][5] < nFim
		aRecAloc[ nAscan ][5] := nFim
	EndIf
	aRecAloc[ nAscan ][6] += H8_BITUSO
	dbSkip()
End

If !Empty( aRecAloc )

	If TRB->TEMPSOB > 0

		dbSelectArea("TRB")
		nRecAntTRB := Recno()
		dbGoto(nRecTRB)

		nQuantProd := TRB->QTDPROD
		cRecurso   := TRB->RECURSO

		// Calcula Tempo de Dura‡„o baseado no Tipo de Operacao
		If AllTrim(TRB->TPOPER) $ " 1" .Or. Empty(TRB->TPOPER)         // BOPS 00000064408  // TRB->TPOPER == " " .Or. TRB->TPOPER == "1"
			nTemp := TRB->QTDPROD * ( IIf( TRB->TEMPAD == 0, 1, TRB->TEMPAD) / IIf( TRB->LOTEPAD == 0, 1, TRB->LOTEPAD ) )
			dbSelectArea("SH1")
			dbSeek(xFilial("SH1")+TRB->RECURSO)
			If Found() .And. H1_MAOOBRA # 0
				nTemp := nTemp / H1_MAOOBRA
			EndIf
			dbSelectArea("TRB")
			nDurTotal := U_YTempo2Bit( nTemp )
			If nDurTotal == 0
				If SH1->(Found()) .And. SH1->H1_MAOOBRA > 1
					u_Y690Ocorre(14,.F.,TRB->OPERAC,TRB->OPNUM+TRB->ITEM+TRB->SEQUEN+TRB->ITEMGRD,TRB->LOTEPAD,TRB->TEMPAD,SH1->H1_MAOOBRA,nTemp*60,TRB->QTDPROD)
				Else
					u_Y690Ocorre(15,.F.,TRB->OPERAC,TRB->OPNUM+TRB->ITEM+TRB->SEQUEN+TRB->ITEMGRD,TRB->LOTEPAD,TRB->TEMPAD,nTemp*60,TRB->QTDPROD)
				EndIf
				Return -99999
			EndIf
		ElseIf AllTrim(TRB->TPOPER) $ "23"   // BOPS 00000064408  // TRB->TPOPER == "2" .Or. TRB->TPOPER == "3"
			nDurTotal := U_YTempo2Bit( IIf( TRB->TEMPAD == 0 , 1 , TRB->TEMPAD ) )
			If nDurTotal == 0
				Return -99999
			EndIf
		EndIf

		If nDurTotal == Nil
			Return -99999	// BOPS 00000064408  //
		Endif

		dbGoto(nRecAntTRB)

		nPecasBit := nQuantProd / nDurTotal

		nBit1Peca := Int( 1 / nPecasBit )+IIf( ( ( 1 / nPecasBit ) - Int( 1 / nPecasBit ) ) > 0, 1, 0)

		For i := 1 to Len( aRecAloc )
			nBitUtil += aRecAloc[i][6]
		Next i

		nBitSobr := 0
		cTpSobre := TRB->TPSOBRE
		nTempSob := TRB->TEMPSOB

		If cTpSobre == "1"
			nBitSobr := Int( nTempSob / nPecasBit )
		ElseIf cTpSobre == "2"
			nBitSobr := NoRound( ( nDurTotal * nTempSob ) / 100 ,0)
		ElseIf cTpSobre == "3" .Or. cTpSobre == " "
			nBitSobr := U_YTempo2Bit( nTempSob )
		EndIf

		nBitSobr := nDurTotal-nBitSobr

		If Len( aRecAloc ) == 1
			cString2 := Space(aRet[4])
		   	cCalStr2 := Space(aRet[4])
		   	
		   	FSeek(aRet[5],PosiMaq(cRecurso,aRet[2])*aRet[4])
		   	
		   	If FRead(aRet[5],@cString2,aRet[4]) # aRet[4] .And. !lShowOCR
				Help(" ",1,"FREADERROR",,Str(FError(),2,0),05,38)
		   	EndIf
		   	
		   	FSeek(aRet[5],PosiMaq(cRecurso,aRet[2])*aRet[4])
		   	If FRead(aRet[5],@cCalStr2,aRet[4]) # aRet[4] .And. !lShowOCR
				Help(" ",1,"FREADERROR",,Str(FError(),2,0),05,38)
		   	EndIf
		   
		   	nBitLiv := 1
		   	nBitAva := 1
		   	
		   	While .T.  
		    	If( u_YBit2On(cString2, aRecAloc[1][4]+ nBitAva, 1, aRet[4])) = 1      
		        	nBitLiv ++
		      	EndIf         
		      		      
		      	If((nBitLiv = nBitSobr) .or. ( aRecAloc[1][4]+ nBitAva >= aRecAloc[1][5]))
		        	Exit
		      	EndIf   
		         
		      	nBitAva ++   
			EndDo
		   
		   	nRet := A690BitPosition(cString2, cCalStr2, nBitSobr, aRecAloc[1][4], aRecAloc[1][4] + nBitAva,aRet)
		Else
			nRet := A690Bit2Position(aRecAloc,nBitSobr,aRet,IIf(cTpSobre=="1",.T.,.F.))
		EndIf
	Else
		nRet := aRet[4] * 8
		For i := 1 to Len( aRecAloc )
			nRet := IIf( aRecAloc[i][4] < nRet, aRecAloc[i][4], nRet )
		Next i

	EndIf

	nRet--

EndIf

Return nRet

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³A690BitPosition³ Autor ³ Waldemiro Lustosa ³ Data ³ 24/09/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Busca qual a posicao em que o N-esimo bit foi alocado.      ³±±
±±³          ³ (Retorna o Bit seguinte `a posicao).                        ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                     ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function A690BitPosition(cString,cCalStr,nQtdBit,nBitIni,nBitFim,aRet)
Local nNextBit, nOk

nNextBit := U_YNeBitFree(cCalStr, nBitIni,aRet,.T.)
While nQtdBit > 0
	If nNextBit == -1
		Exit
	EndIf
	If nNextBit >= nBitFim
		nNextBit := nBitFim
		Exit
	EndIf
	nOk := u_YBit2On(cString,nNextBit,1,aRet[4])
	If nOk == 0      // Ocupado
		nQtdBit--
	ElseIf nOk == -1
		nNextBit := -1
		Exit
	Endif
	nNextBit++
	If u_YBit2On(cCalStr,nNextBit,1,aRet[4]) # 1 .And. nQtdBit > 0
		nNextBit := U_YNeBitFree(cCalStr, nNextBit,aRet,.T.)
	EndIf
End

Return nNextBit
/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³A690Bit2Position³ Autor ³ Waldemiro Lustosa³ Data ³ 24/09/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Busca qual a posi‡„o em que o N-‚simo bit foi alocado em    ³±±
±±³          ³ uma opera‡„o com desdobramentos.                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                     ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function A690Bit2Position(aRecAloc,nBitSobr,aRet,lBit1Peca)
Local i,k,nNextBit,nStrOk, nCalOk, nNumRec, nUltimoBit := 0,nPosicao:=0
Local cCond := ".T.", nPrimeiroBit := 0

lBit1Peca := IIf( lBit1Peca == NIL, .F., lBit1Peca)

If mv_par01 == 2
	ASort( aRecAloc,,, { |x, y| x[4] < y[4] } )
	nBit := aRecAloc[1][4]
	nNumRec := 1
	For i := 2 to Len( aRecAloc )
		If aRecAloc[1][4] == aRecAloc[i][4]
			nNumRec++
		Else
			Exit
		EndIf
	Next i
	For i := 1 to Len( aRecAloc )
		If  aRecAloc[i][5] > nUltimoBit
			nUltimoBit:=aRecAloc[i][5]
			nPosicao:=i
		EndIf
	Next i

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Foi alterado o calendario desta funcao para considerar o calendario³
	//³do recurso que iniciou primeiro. Bops 00000125933                  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	//nBit:=A690BitPosition(aRecAloc[nPosicao,2],aRecAloc[1,3],nBitSobr,nBit,nUltimoBit,aRet)
	nBit:=A690BitPosition(aRecAloc[1,2],aRecAloc[1,3],nBitSobr,nBit,nUltimoBit,aRet)
Else
	ASort( aRecAloc,,, { |x, y| x[5] > y[5] } )
	nBit := aRecAloc[1][5] - 1
	nNumRec := 1
	For i := 2 to Len( aRecAloc )
		If aRecAloc[1][5] == aRecAloc[i][5]
			nNumRec++
		Else
			Exit
		EndIf
	Next i
	nPrimeiroBit := aRet[4] * 8
	For i := 1 to Len( aRecAloc )
		nPrimeiroBit := IIf( aRecAloc[i][4] < nPrimeiroBit, aRecAloc[i][4], nPrimeiroBit )
	Next i
	While nBitSobr > 0 .Or. nBit1Peca > ( aRecAloc[1][5] - nBit )
		For i := 1 to nNumRec
			nStrOk := u_YBit2On(aRecAloc[i][2],nBit,1,aRet[4])
			nCalOk := u_YBit2On(aRecAloc[i][3],nBit,1,aRet[4])
			If nStrOk == 0 .And. nCalOk == 1
				nBitSobr--
			EndIf
			If nBitSobr <= 0 .And. nBit1Peca <= ( aRecAloc[1][5] - nBit )
				Exit
			EndIf
		Next i
		If nBitSobr > 0 .Or. nBit1Peca > ( aRecAloc[1][5] - nBit )
			nBit--
			If nBit == nPrimeiroBit - 1
				Exit
			EndIf
			If nNumRec < Len( aRecAloc )
				k := nNumRec
				For i := k to Len( aRecAloc )
					If nBit == aRecAloc[i][5]
						nNumRec++
					Else
						Exit
					EndIf
				Next i
			EndIf
		EndIf
	End
EndIf
Return nBit
/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³u_A690CalcBit ³ Autor ³ Waldemiro Lustosa   ³ Data ³ 02/10/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Calcula Bit Inicial para aloca‡„o pelo Fim em uma Aloca‡„o ³±±
±±³          ³ pelo Inicio (Situacao que ocorre quando h  sobreposi‡„o em ³±±
±±³          ³ uma aloca‡„o e a opera‡„o a ser alocada n„o ultrapassa a   ³±±
±±³          ³ opera‡„o anterior, n„o atinge o nBitLimit).                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
User Function Y690CalcBit(aAlter,aSecun,aRet)
Local nRet := aRet[4]*8, nBit, lOk := .F., i

For i := 1 to Len(aAlter) + 1 // principal e alternativos
	If i == 1
		cString := Space(aRet[4])
		FSeek(aRet[1],PosiMaq(TRB->RECURSO,aRet[2])*aRet[4])
		If FRead(aRet[1],@cString,aRet[4]) # aRet[4] .And. !lShowOCR
			Help(" ",1,"FREADERROR",,Str(FError(),2,0),05,38)
		EndIf
		nBit := U_YNeBitFree(cString,nBitLimit,aRet)
	Else
		cString := Space(aRet[4])
		FSeek(aRet[1],PosiMaq(aAlter[i-1],aRet[2])*aRet[4])
		If FRead(aRet[1],@cString,aRet[4]) # aRet[4] .And. !lShowOCR
			Help(" ",1,"FREADERROR",,Str(FError(),2,0),05,38)
		EndIf
		nBit := U_YNeBitFree(cString,nBitLimit,aRet)
	EndIf
	If nBit # -1
		nRet := IIf( nBit < nRet, nBit, nRet )
		lOk := .T.
	EndIf
Next i
If !lOk .And. !Empty(aSecun)
	For i := 1 to Len(aSecun) // secundarios
		cString := Space(aRet[4])
		FSeek(aRet[1],PosiMaq(aSecun[i],aRet[2])*aRet[4])
		If FRead(aRet[1],@cString,aRet[4]) # aRet[4] .And. !lShowOCR
			Help(" ",1,"FREADERROR",,Str(FError(),2,0),05,38)
		EndIf
		nBit := U_YNeBitFree(cString,nBitLimit,aRet)
		If nBit # -1
			nRet := IIf( nBit < nRet, nBit, nRet )
			lOk := .T.
		EndIf
	Next i
EndIf

If !lOk
	nRet := -1
Else
	nBit1Peca := nRet-nBitLimit+1
EndIf

Return nRet

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ u_A690Ajusta ³ Autor ³ Waldemiro Lustosa   ³ Data ³ 10/10/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Fun‡„o que verifica se, em uma aloca‡„o pelo Fim, a Opera- ³±±
±±³          ³ ‡„o alocada esta respeitando o Tempo de Sobreposi‡„o, caso ³±±
±±³          ³ n„o esteja, desfaz a opera‡„o, retorna outro valor para    ³±±
±±³          ³ nBit e for‡a o reinicio do processamento desta Opera‡„o.   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
User Function Y690Ajusta(aRet,lFirstAjust,nBitAjust)
Local nRet, cAlias := Alias(), nRecTRB, nSeqAloc, nTempSob, cTpSobre
Local nRecAntTRB,cOp

nSeqAloc := Val(TRB->SEQALOC)
cOp := TRB->OPNUM+TRB->ITEM+TRB->SEQPAI+TRB->ITEMGRD
dbSelectArea("TRB")
nRecTRB := Recno()
dbSetOrder(2)
dbSeek(StrZero(nSeqAloc-1,7),.T.)
While !Bof()
	If OPERALOC .And. Recno() # nRecTRB .And. cOp == TRB->OPNUM+TRB->ITEM+TRB->SEQUEN+TRB->ITEMGRD
		If TEMPSOB # 0 .Or. !Empty(TPSOBRE)
			nTempSob :=	TRB->TEMPSOB
			cTpSobre := TRB->TPSOBRE
			nRecAntTRB := Recno()
		EndIf
		Exit
	EndIf
	dbSkip(-1)
End

dbSelectArea("TRB")
dbSetOrder(1)
dbGoto(nRecTRB)

If nRecAntTRB # NIL
	nRet := A690SobrAjust(OPNUM+ITEM+SEQUEN+ITEMGRD+OPERAC,nTempSob,cTpSobre,aRet,nRecAntTRB,@lFirstAjust,@nBitAjust)
EndIf

nRet := IIf( nRet == NIL, 1, nRet )

dbSelectArea(cAlias)
Return IIf( nRet > 0, .T., .F.)
/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³A690SobrAjus³ Autor ³ Waldemiro Lustosa   ³ Data ³ 10/10/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Fun‡„o que verifica se, em uma aloca‡„o pelo Fim, a Opera- ³±±
±±³          ³ ‡„o alocada esta respeitando o Tempo de Sobreposi‡„o, caso ³±±
±±³          ³ n„o esteja, desfaz a opera‡„o, retorna outro valor para    ³±±
±±³          ³ nBit e for‡a o reinicio do processamento desta Opera‡„o.   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function A690SobrAjust(cChaveSH8,nTempSob,cTpSobre,aRet,nRecAntTRB,lFirstAjust,nBitAjust)
Local i, aRecAloc := {}, cString, cCalStr, nHora, nInicio, nFim
Local cCalend, nAscan, nBitIni, nBitFim, lFirst := .T., nRet := -99999
Local nPecasBit, nBitSobr, nDurTotal, nQuantProd, cRecurso, nRetSH8
Local nIniAnt, nRecTRB

dbSelectArea("CARGA")
dbSetOrder(1)
dbSeek(xFilial("SH8")+cChaveSH8)
If !Found()
	Return nRet
EndIf

While !Eof() .And. xFilial("SH8")+cChaveSH8 == H8_FILIAL+H8_OP+H8_OPER
	nAscan := Ascan( aRecAloc, { |x| x[1] == H8_RECURSO } )
	If nAscan == 0
		cString := Space(aRet[4])
		cCalStr := Space(aRet[4])
		cRecurso := H8_RECURSO
		FSeek(aRet[5],PosiMaq(cRecurso,aRet[2])*aRet[4])
		If FRead(aRet[5],@cString,aRet[4]) # aRet[4] .And. !lShowOCR
			Help(" ",1,"FREADERROR",,Str(FError(),2,0),05,38)
		EndIf
		FSeek(aRet[5],PosiMaq(cRecurso,aRet[2])*aRet[4])
		If FRead(aRet[5],@cCalStr,aRet[4]) # aRet[4] .And. !lShowOCR
			Help(" ",1,"FREADERROR",,Str(FError(),2,0),05,38)
		EndIf
		Aadd( aRecAloc, { cRecurso, cString, cCalStr, NIL, NIL, 0, H8_QUANT})
		nAscan := Len( aRecAloc )
	EndIf

	nHora := Val(Substr(H8_HRINI,1,2)+"."+Substr(H8_HRINI,4,2))
	nInicio:= DtHr2Bit(H8_DTINI,nHora)
	If nInicio < 1
		nInicio := 1
	Endif
	nHora := Val(Substr(H8_HRFIM,1,2)+"."+Substr(H8_HRFIM,4,2))
	nFim := DtHr2Bit(H8_DTFIM,nHora)
	If nFim < 1
		nFim := 1
	EndIf
	cCalend := aRecAloc[ nAscan ][2]
	StuffBit(@cCalend,nInicio,nFim-nInicio,aRet[4])
	aRecAloc[ nAscan ][2] := cCalend
	If aRecAloc[ nAscan ][4] == NIL
		aRecAloc[ nAscan ][4] := nInicio
	ElseIf aRecAloc[ nAscan ][4] > nInicio
		aRecAloc[ nAscan ][4] := nInicio
	EndIf
	If aRecAloc[ nAscan ][5] == NIL
		aRecAloc[ nAscan ][5] := nFim
	ElseIf aRecAloc[ nAscan ][5] < nFim
		aRecAloc[ nAscan ][5] := nFim
	EndIf
	aRecAloc[ nAscan ][6] += H8_BITUSO
	dbSkip()
End

If !Empty( aRecAloc )

	If nTempSob > 0

		nQuantProd := aRecAloc[1][7]
		nDurTotal := 0

		If Len( aRecAloc ) == 1
			nDurTotal := aRecAloc[1][6]
			nBitLimit := aRecAloc[1][5]
		Else
			For i := 1 to Len( aRecAloc )
				nDurTotal += aRecAloc[i][6]
				nBitLimit := IIf( aRecAloc[i][5] > nBitLimit, aRecAloc[i][5], nBitLimit )
			Next i
		EndIf

		nPecasBit := nQuantProd / nDurTotal

		nBit1Peca := Int( 1 / nPecasBit )+IIf( ( ( 1 / nPecasBit ) - Int( 1 / nPecasBit ) ) > 0, 1, 0)

		If cTpSobre == "1"
			nBitSobr := Int( nTempSob / nPecasBit )
		ElseIf cTpSobre == "2"
			nBitSobr := NoRound( ( nDurTotal * nTempSob ) / 100 ,0)
		ElseIf cTpSobre == "3" .Or. cTpSobre == " "
			nBitSobr := U_YTempo2Bit( nTempSob )
		EndIf

		mv_par01 := 2
		If Len( aRecAloc ) == 1
			nRet := A690BitPosition(aRecAloc[1][2], aRecAloc[1][3], nBitSobr, aRecAloc[1][4], aRecAloc[1][5],aRet)
		Else
			nRet := A690Bit2Position(aRecAloc,nBitSobr,aRet,IIf(cTpSobre=="1",.T.,.F.))
		EndIf
		mv_par01 := 1

	Else
		nRet := aRet[4] * 8
		For i := 1 to Len( aRecAloc )
			nRet := IIf( aRecAloc[i][4] < nRet, aRecAloc[i][4], nRet )
		Next i
	EndIf

EndIf

dbSelectArea("TRB")
nRecTRB := Recno()
dbGoto(nRecAntTRB)
dbSelectArea("CARGA")
dbSetOrder(1)
dbSeek(xFilial("SH8")+TRB->OPNUM+TRB->ITEM+TRB->SEQUEN+TRB->ITEMGRD+TRB->OPERAC)
If !Found()
	Return nRet
EndIf

nIniAnt := aRet[4] * 8

While !Eof() .And. xFilial("SH8")+TRB->OPNUM+TRB->ITEM+TRB->SEQUEN+TRB->ITEMGRD+TRB->OPERAC == H8_FILIAL+H8_OP+H8_OPER
	nHora := Val(Substr(H8_HRINI,1,2)+"."+Substr(H8_HRINI,4,2))
	nInicio:= DtHr2Bit(H8_DTINI,nHora)
	If nInicio < 1
		nInicio := 1
	Endif
	nIniAnt := IIf( nInicio < nIniAnt, nInicio, nIniAnt )
	dbSkip()
End

dbSelectArea("TRB")
dbGoto(nRecTRB)

If lFirstAjust
	lFirstAjust := .F.
	If nRet > nIniAnt
		If nRet+Int( Sqrt( nRet - nIniAnt )) > nIniAnt
			nBitAjust := Int( Sqrt( nRet - nIniAnt ) )
		EndIf
	EndIf
EndIf

Return IIf( nRet <= nIniAnt, nRet, -1 )
/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³u_A690DesfazSH8³ Autor ³ Waldemiro Lustosa  ³ Data ³ 11/10/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Desfaz toda a aloca‡„o.                                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
user Function Y690DesfazSH8(nSubDivHdl,aRet,aRegFerr,aSubDiv,aFerram)
Local i, j, k, cBuffer, cRecurso, cString, nNumSubDiv
Local aArea := GetArea()

u_Y690NaoAlocada(TRB->(OPNUM+ITEM+SEQUEN+ITEMGRD), .T.)

If mv_par03 == 1 .And. !Empty( aFerram )
	For i := 1 to Len(aSubDiv)
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ DesAloca o registro de ferramenta disponivel  ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		For k := 1 to Len( aFerram )
			A690FerrAloc(aFerram[k],aSubDiv[i,1],aSubDiv[i,2],aRegFerr[i,1],.F.,aRet)
		Next k
	Next i
Endif

// Desfaz marcas no Arquivo TRB
dbSelectArea("TRB")
Replace OPERALOC With .F.

// Desfaz SH8 e Arquivos Binarios:
dbSelectArea("SH8")
dbSetOrder(1)
dbSeek(xFilial("SH8")+TRB->OPNUM+TRB->ITEM+TRB->SEQUEN+TRB->ITEMGRD)
While !Eof() .And. TRB->OPNUM+TRB->ITEM+TRB->SEQUEN+TRB->ITEMGRD == H8_OP
	FSeek( nSubDivHdl,SH8->H8_SUBDIV)
	cBuffer := Space(14)
	If FRead( nSubDivHdl,@cBuffer,14) # 14 .And. !lShowOCR
		Help(" ",1,"FREADERROR",,Str(FError(),2,0),05,38)
	EndIf
	If cBuffer # TRB->OPNUM+TRB->ITEM+TRB->SEQUEN+TRB->ITEMGRD
	*	Alert("You have dangerous problems with your Binary File !!!") //"You have dangerous problems with your Binary File !!!"
		Help(" ",1,"A690ErrBin",,RetTitle("H6_OP") + ": " + TRB->(OPNUM+ITEM+SEQUEN+ITEMGRD),05,38)
		Return .F.
	EndIf
	cRecurso := Space(6)
	If FRead( nSubDivHdl,@cRecurso,6) # 6 .And. !lShowOCR
		Help(" ",1,"FREADERROR",,Str(FError(),2,0),05,38)
	EndIf
	nNumSubDiv := Space(3)
	If FRead( nSubDivHdl,@nNumSubDiv,3) # 3 .And. !lShowOCR
		Help(" ",1,"FREADERROR",,Str(FError(),2,0),05,38)
	EndIf
	nNumSubDiv := Val(nNumSubDiv)
	For j := 1 to nNumSubDiv
		cBuffer := Space(12)
		If FRead( nSubDivHdl,@cBuffer,12) # 12 .And. !lShowOCR
			Help(" ",1,"FREADERROR",,Str(FError(),2,0),05,38)
		EndIf
		FSeek(aRet[1],PosiMaq(cRecurso,aRet[2])*aRet[4])
		cString := Space(aRet[4])
		If FRead(aRet[1],@cString,aRet[4]) # aRet[4] .And. !lShowOCR
			Help(" ",1,"FREADERROR",,Str(FError(),2,0),05,38)
		EndIf
		YUnStuff2(@cString,Val(Substr(cBuffer,1,6)),Val(Substr(cBuffer,7,6)),aRet[4])
		FSeek(aRet[1],PosiMaq(cRecurso,aRet[2])*aRet[4])
		If FWrite(aRet[1],cString,aRet[4]) < aRet[4] .And. !lShowOCR
			Help(" ",1,"FWRITERROR",,Str(FError(),2,0),05,38)
		EndIf
	Next j
	RecLock("SH8",.F.)
	dbDelete()
	MsUnLock()
	dbSkip()
End

dbSelectArea("CARGA")
dbSetOrder(1)
dbSeek(xFilial("SH8")+TRB->OPNUM+TRB->ITEM+TRB->SEQUEN+TRB->ITEMGRD)
While !Eof() .And. TRB->OPNUM+TRB->ITEM+TRB->SEQUEN+TRB->ITEMGRD == H8_OP
	RecLock("CARGA",.F.)
	dbDelete()
	MsUnLock()
	dbSkip()
End

RestArea(aArea)

Return NIL

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³u_A690FechaArq ³ Autor ³ Waldemiro Lustosa  ³ Data ³ 05/12/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Fecha Arquivos e Apaga-os do Winchester.                   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
user Function Y690FechaArq(aArray)
Local i
For i := 1 to Len(aArray)
	FClose(aArray[i][1])
	If File(aArray[i][2])
		FErase(aArray[i][2])
	EndIf
Next i
Return NIL

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ u_YBit2On      ³ Autor ³ Waldemiro Lustosa  ³ Data ³ 12/12/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Executa a fun‡„o BitOn validando os parƒmetros             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
user Function YBit2On(x,y,k,z)
Return IIf(y>0,BitOn(x,y,k,z),-1)

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ YUnStuff2    ³ Autor ³ Waldemiro Lustosa  ³ Data ³ 27/12/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Executa a fun‡„o UnStuff validando os parƒmetros           ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function YUnStuff2(x,y,k,z)
Return IIf(y>0,IIf(k>0,IIf(Len(x)==z,UnStuff(@x,y,k,z),-1),-1),-1)


/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³u_A690HoraCt³ Autor ³ Rodrigo de A. Sartorio³ Data ³ 14/05/97 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Tranforma o tempo normal em tempo centesimal               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ ExpN1=u_A690HoraCt(ExpC2)                                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpN1 = Retorna o tempo centesimal                         ³±±
±±³          ³ ExpC2 = Tempo a ser transformado Ex. "02.30"               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAPCP                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
user Function Y690HoraCt(nTempo)
If cTipoTemp # "C"
	nTempo:=Int(nTempo)+(((nTempo-Int(nTempo))/60)*100)
EndIf
Return nTempo

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ u_A690AtuCarga³ Autor ³ Waldemiro Lustosa  ³ Data ³ 25/01/96 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Fun‡„o que atualiza arquivos bin rios da Carga e Ferramen. ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
user Function Y690AtuCarga(cCalStr, aRecursos, cUltFerr, aRet, cRecurso, aSubDiv, aFerram, aRegFerr,lIlimitado)
Local i, l, cString, nPosAsBin := 1, nPosArray, nInicio, nFim, aDtHrIni, aDtHrFim
Local nIniLocFer,nFimLocFer,nTmpBitAux
Local aProcess := {}
Local lOneAloc := .T.
lIlimitado:= IF(lIlimitado == NIL,.F.,lIlimitado)

// Caso recurso nao seja ilimitado
If !lIlimitado
	cString := Space(aRet[4])
	cCalStr := Space(aRet[4])
	FSeek(aRet[1],PosiMaq(cRecurso,aRet[2])*aRet[4])
	If FRead(aRet[1],@cString,aRet[4]) # aRet[4] .And. !lShowOCR
		Help(" ",1,"FREADERROR",,Str(FError(),2,0),05,38)
	EndIf
	FSeek(aRet[5],Posimaq(cRecurso,aRet[2])*aRet[4])
	If FRead(aRet[5],@cCalStr,aRet[4]) # aRet[4] .And. !lShowOCR
		Help(" ",1,"FREADERROR",,Str(FError(),2,0),05,38)
	EndIf

	If aRecursos[nPosAsBin][1] # TRB->RECURSO
		nPosAsBin := u_YA690AsBin( aRecursos, TRB->RECURSO )
	EndIf
	If nPosAsBin > 0
		For i:= 1 to Len(aSubDiv)
			StuffBit(@cString,aSubDiv[i][1],aSubDiv[i][2],aRet[4])
			nPosArray := Ascan( aRecursos[ nPosAsBin ][4] , { |x| x[1] == TRB->PRODUTO } )
			If nPosArray == 0
				Aadd( aRecursos[ nPosAsBin ][4], { TRB->PRODUTO, TRB->OPERAC, { aSubDiv[i][1], aSubDiv[i][1]+aSubDiv[i][2]-1,TRB->OPNUM+TRB->ITEM+TRB->SEQUEN+TRB->ITEMGRD,cRecurso }} )
			Else
				Aadd( aRecursos[ nPosAsBin ][4][ nPosArray ], { aSubDiv[i][1], aSubDiv[i][1]+aSubDiv[i][2]-1,TRB->OPNUM+TRB->ITEM+TRB->SEQUEN+TRB->ITEMGRD,cRecurso } )
			EndIf
			If mv_par03 == 1 .And. !Empty(aFerram)
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Aloca o registro de ferramenta disponivel  ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				For l := 1 to Len( aFerram )
					If Empty(AsCan(aProcess,{|x|x[1]==TRB->OPNUM+TRB->ITEM+TRB->SEQUEN+TRB->ITEMGRD}))
						Aadd(aProcess,{TRB->OPNUM+TRB->ITEM+TRB->SEQUEN+TRB->ITEMGRD,TRB->TPALOCF})
						lOneAloc := .T.
					Else
						If TRB->TPALOCF=="1"
							Loop
						EndIf
					EndIf				
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³ Verifica a alocacao da ferramenta          ³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					If TRB->TPALOCF=="1"		//Aloca ferramenta somente durante Setup
						nIniLocFer := aSubDiv[i,1]
						nFimLocFer := u_YASetupG()
					ElseIf TRB->TPALOCF=="2" .And. lOneAloc   //Aloca ferramenta somente durante Operacao
						lOneAloc   := .F.
						nIniLocFer := aSubDiv[i,1]+u_YASetupG()
						nFimLocFer := aSubDiv[i,2]-u_YASetupG()		   			
						If nFimLocFer < 1
							nFimLocFer := 1
						EndIf
					Else
						nIniLocFer := aSubDiv[i,1]
						nFimLocFer := aSubDiv[i,2]
					EndIf

					A690FerrAloc(aFerram[l],nIniLocFer,nFimLocFer,aRegFerr[i,l],.T.,aRet)
					nInicio := nIniLocFer
					nFim    := nIniLocFer+nFimLocFer
					aDtHrIni:=Bit2DtHr(nInicio,dDataPar)
					aDtHrFim:=Bit2DtHr(nFim,dDataPar)

					dbSelectArea("FER")
					dbAppend()

					Replace  HE_FILIAL With xFilial("SHE"),;
						HE_PRODUTO With TRB->PRODUTO,;
						HE_CODIGO With TRB->CODIGO,;
						HE_OPERAC With TRB->OPERAC,;
						HE_FERRAM With aFerram[l],;
						HE_DTINI With aDtHrIni[1],;
						HE_HRINI With aDtHrIni[2],;
						HE_DTFIM With aDtHrFim[1],;
						HE_HRFIM With aDtHrFim[2],;
						HE_OP With TRB->OPNUM+TRB->ITEM+TRB->SEQUEN+TRB->ITEMGRD

				Next l
				cUltFerr := aFerram[1]+StrZero(aRegFerr[i,1],6)
			EndIf
		Next i
	EndIf
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Grava String com a operacao alocada                  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	FSeek(aRet[1],PosiMaq(cRecurso,aRet[2])*aRet[4])
	If FWrite(aRet[1],cString,aRet[4]) < aRet[4] .And. !lShowOCR
		Help(" ",1,"FWRITERROR",,Str(FError(),2,0),05,38)
	EndIf
EndIf
Return NIL

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³u_Y690Ocorre³ Autor ³ Ary Medeiros          ³ Data ³          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Revis„o  ³ Waldemiro L. Lustosa                     ³ Data ³ 13/09/95 ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
user Function Y690Ocorre(nTipo,lPergunta,uVar1,uVar2,uVar3,uVar4,uVar5,uVar6,uVar7)
Local i, nHdl,cAlias := Alias(), cFile, nTamArq, nLin, nTamText
Local  cVarText
Local cBuffer, cText := "", lRet := .T.
Local cProduto := ""
Local oDlg,oOcorr,aOcorr:={}
Local aArea := GetArea()

Static lContOcor := Nil

lPergunta := IIf( lPergunta == NIL , .F. , lPergunta )
lOcorreu  := .T.
cFile := cDirPcp+cNameCarga+".OCR"
If !File(cFile)
	lShowOCR := (MV_PAR18 == 1)
	nHdl := MSFCREATE(cFile,1)
Else
	nHdl := FOpen(cFile,2+64)
Endif

If !u_Y690IsBat() .And. (fError() <> 0) .And. (lContOcor==Nil)
	lContOcor := MsgYesNo("Não foi possível a Abertura\Criação do arquivo "+cNameCarga+".OCR"+" no diretório "+cDirPcp+". Verifique com o Administrado de Rede as permissões de acesso ao Arquivo\Diretório informados."+" Devido a essa inconsistência não será possível exibir o Log de Ocorrências do Carga Máquina. Deseja prosseguir o processamento ?","Atenção") //"Não foi possível a Abertura\Criação do arquivo "##" no diretório "##". Verifique com o Administrado de Rede as permissões de acesso ao Arquivo\Diretório informados."##" Devido a essa inconsistência não será possível exibir o Log de Ocorrências do Carga Máquina. Deseja prosseguir o processamento ?"##"Atenção"
	If !lContOcor
		Final("Processamento Cancelado !!!") //"Processamento Cancelado !!!"	
	EndIf
EndIf

If (lContOcor == Nil)
	If nTipo == 1
		u_A690AddLin(@cText,"Não existem Recursos cadastrados. Processamento cancelado.")	//"N„o existem Recursos cadastrados. Processamento cancelado."
	ElseIf nTipo == 2
		u_A690AddLin(@cText,"O calendário "+uVar1+", cadastrado no Recurso "+uVar2+", não existe.")	//"O calend rio "###", cadastrado no Recurso "###", n„o existe."
		u_A690AddLin(@cText,"Processamento cancelado.")	//"Processamento cancelado."
	ElseIf nTipo == 3
		uVar2 := Alltrim(uVar2)
		u_A690AddLin(@cText,"Não existe Roteiro de Operação Padrão "+uVar1+" para o Produto "+IIf( Len(uVar2) < 7, uVar2+"," , "" ))	//"Não existe Roteiro de Operação Padrão "###" para o Produto "
		u_A690AddLin(@cText,IIf( Len(uVar2) >= 7, uVar2+",", "")+" ele será desconsiderado."+" (OP"+uVar3+")")	//" ele ser  desconsiderado."
	ElseIf nTipo == 4
		u_A690AddLin(@cText,"Não há Ordens de Produção selecionadas para Alocação.")	//"Não há Ordens de Produção selecionadas para Alocação."
	ElseIf nTipo == 5
		u_A690AddLin(@cText,"A Ordem de Produção "+uVar1+"não pode ser alocada porque tem")	//"A Ordem de Produ‡„o "###" n„o pode ser alocada porque tem"
		If uVar2 == dDataPar
			u_A690AddLin(@cText,"Data Prevista de Entrega no dia "+Dtoc(uVar2)+" (igual a data base).")	//"Data Prevista de Entrega no dia "###" (igual a data base)."
		Else
			u_A690AddLin(@cText,"Data Prevista de Entrega no dia "+Dtoc(uVar2)+" (anterior a data base).")	//"Data Prevista de Entrega no dia "###" (anterior a data base)."
		EndIf
	ElseIf nTipo == 6
		uVar3 := Alltrim(uVar3)
		u_A690AddLin(@cText,"O Recurso "+uVar1+", cadastrado na Operação "+uVar2+" do Roteiro de")	//"O Recurso "###", cadastrado na Opera‡„o "###" do Roteiro de"
		u_A690AddLin(@cText,"Operações do Produto "+uVar3+", não foi encontrado no")	//"Opera‡”es do Produto "###", n„o foi encontrado no"
		u_A690AddLin(@cText,"Cadastro de Recursos, esta opera‡„o será desconsiderada.")	//"Cadastro de Recursos, esta opera‡„o ser  desconsiderada."
	ElseIf nTipo == 7
		uVar4 := Alltrim(uVar4)
		If uVar1 == "S"
			cVarText := "Secundrio"	//"Secund rio"
		Else
			cVarText := "Alternativo"	//"Alternativo"
		EndIf
		u_A690AddLin(@cText,"O Recurso "+cVarText+" "+uVar2+", cadastrado na Operação "+uVar3+" do Roteiro de")	//"O Recurso "###", cadastrado na Opera‡„o "###" do Roteiro de"
		u_A690AddLin(@cText,"Operações do Produto "+uVar4+", não foi encontrado no")	
		u_A690AddLin(@cText,"Cadastro de Recursos, ele será desconsiderado.")	
	ElseIf nTipo == 8
		cProduto := Alltrim(TRB->PRODUTO)+") "
		u_A690AddLin(@cText,"Não foi possível alocar a Operação "+uVar1+" (OP "+uVar2+" Produto")	
		If uVar3
			uVar3 := .F.
			u_A690AddLin(@cText,cProduto+"dentro do per¡odo definido na Carga  Máquina,  provavelmente  o  pe-") 
			u_A690AddLin(@cText,"ríodo entre a Data Prevista de Entrega e a Data Base n„o seja")	
			u_A690AddLin(@cText,"suficiente para a alocação das operações.")	
		Else
			u_A690AddLin(@cText,"dentro do per¡odo definido para a Carga Máquina.")	
		EndIf
	ElseIf nTipo == 9
		cProduto := Alltrim(TRB->PRODUTO)+") "
		u_A690AddLin(@cText,"Não foi poss¡vel alocar a Operação "+uVar1+" (OP "+uVar2+" Produto"	)	
		u_A690AddLin(@cText,cProduto+"dentro do per¡odo definido para a Carga Máquina.")
	ElseIf nTipo == 10
		u_A690AddLin(@cText,"Não há ferramentas "+uVar1+" disponíveis para alocação da operação "+uVar2)	
		u_A690AddLin(@cText," (OP "+uVar3+").")	//" (OP "
	ElseIf nTipo == 11
		u_A690AddLin(@cText,"A Operação "+uVar1+" não pode ser alocada na melhor posição")	//"A Opera‡„o "###" n„o pode ser alocada na melhor posi‡„o"
		u_A690AddLin(@cText,"do Recurso "+uVar2+", pois n„o há ferramenta "+uVar3+" dispon¡vel")	//"do Recurso "###", pois n„o h  ferramenta "###" dispon¡vel"
		u_A690AddLin(@cText," (OP "+uVar4+").")	//" (OP "
	ElseIf nTipo == 12
		cProduto := Alltrim(TRB->PRODUTO)+") "
		u_A690AddLin(@cText,"Não foi possível alocar a Operaçao "+uVar1+" (OP "+uVar2+" Produto")	//"Não foi possível alocar a Operaçao "###" (OP "###" Produto"
		If uVar3
			uVar3 := .F.
			u_A690AddLin(@cText,cProduto+"dentro do per¡odo definido na Carga Máquina,  esta  operação  está  u-")
			u_A690AddLin(@cText,"tilizando desdobramento e sobreposi‡„o para ser alocada, aumen-")
			u_A690AddLin(@cText,"te o Tempo de Desdobramento ou utilize Desdobramento Proporcio-")
			u_A690AddLin(@cText,"para tentar solucionar esta Ocorrência (Detectei "+Alltrim(Str(uVar4,4))+" desdobra-")
			u_A690AddLin(@cText,"mentos para apenas "+Alltrim(Str(uVar5+1,4))+" Recursos - Principal e Alternativos).")
		Else
			u_A690AddLin(@cText,"do per¡odo definido na Carga M quina (Ver dica acima).")
		EndIf
	ElseIf nTipo == 13
		u_A690AddLin(@cText,"A ferramenta "+uVar1[1]+" tem "+Str(uVar2,4,0)+" pe‡as dispon¡veis. Na montagem dos")	//######
		u_A690AddLin(@cText,"Arquivos de trabalho foi detectado um bloqueio desta ferramenta")
		u_A690AddLin(@cText,"de "+Str(uVar1[2],4,0)+" pe‡as. Todas as pe‡as desta ferramenta foram bloqueadas")
		u_A690AddLin(@cText,"(Período entre "+Dtoc(uVar1[3])+" …s "+StrTran(Str(uVar1[4],5,2),".",":")+" e "+Dtoc(uVar1[5])+" …s "+StrTran(Str(uVar1[4],5,2),".",":")+").")	
	ElseIf nTipo == 14
		cProduto := Alltrim(TRB->PRODUTO)+") "
		u_A690AddLin(@cText,"Não foi poss¡vel alocar a Opera‡„o "+uVar1+" "+" (OP "+" "+uVar2+" Produto")	//######" Produto"
		u_A690AddLin(@cText,cProduto+"pois com um Lote Padr„o de "+Str(uVar3,6,0)+", um Tempo Padr„o de "+Str(uVar4,6,2)+", e  com")	//######
		u_A690AddLin(@cText,"o Campo Eficiência (Mão de Obra) preenchido com "+Str(uVar5,3,0)+"  (no Cadas-")	//###
		u_A690AddLin(@cText,"tro de Recursos), o  Sistema não consegue alocar  uma  Operação")
		u_A690AddLin(@cText,"que  dura "+IIf(Int(uVar6)==Round(uVar6,4),Str(uVar6,11,0),Str(uVar6,7,4))+" minutos  (para "+IIf(Int(uVar7)==uVar7,Str(uVar7,12,0),Str(uVar7,8,4))+"  pe‡as  nesta")	//######
		u_A690AddLin(@cText,"OP), pois o Período Mínimo da Carga Máquina, de "+Str(60/nPrecisao,2,0)+" minutos.")
	ElseIf nTipo == 15
		cProduto := Alltrim(TRB->PRODUTO)+") "
		u_A690AddLin(@cText,"Não foi possível alocar a Opera‡„o "+uVar1+" "+" (OP "+uVar2+" Produto")	
		u_A690AddLin(@cText,cProduto+"pois com um Lote Padrão de "+Str(uVar3,6,0)+", um Tempo Padrão de "+Str(uVar4,6,2)+",")	
		u_A690AddLin(@cText,"o Sistema não consegue alocar uma Operação que dura "+IIf(Int(uVar5)==Round(uVar5,4),Str(uVar5,11,0),Str(uVar5,7,4))+" ")
		u_A690AddLin(@cText," minutos (para "+IIf(Int(uVar6)==uVar6,Str(uVar6,12,0),Str(uVar6,8,4))+" pe‡as nesta OP), pois o Período Mínimo")
		u_A690AddLin(@cText,"da Carga Máquina, de "+Str(60/nPrecisao,2,0)+" minutos.")
	ElseIf nTipo == 16 
		u_A690AddLin(@cText,'Quando integração com SIGASFC ativa, não será possível utilizar roteiro alternativo. Produto: ' + alltrim(uVar1) + ' Roteiro: ' + alltrim(uVar2)) //  ## 
	ElseIf nTipo == 17
		u_A690AddLin(@cText,'A ordem de produção ' + alltrim(uVar1) + ' já foi iniciada no Chão de Fábrica. ') //  ## 
	ElseIf nTipo == 18
		u_A690AddLin(@cText,"Não foi poss¡vel alocar a Operação " + uVar5 + " (OP " + uVar6 + "pois a data de validade da operação não é suficiente para realizar esta alocação. Validade da operação: " + DtoC(uVar3) + " até " + DtoC(uVar4) + ". Alocação da operação: " + DtoC(uVar1) + " até " + DtoC(uVar2) + ".") 
	EndIf
                             
	If !Empty(nTipo)
		u_A690AddLin(@cText,Space(10)	)
	EndIf

	nTamArq := FSeek(nHdl,0,2)
	nLin := nTamArq / 65
	nTamText := Len(cText) / 65

	If !u_Y690IsBat() .And. lPergunta .And. (MV_PAR18 == 1)
		For i := 1 to nTamText
			AADD(aOcorr,OemToAnsi(Substr(cText,1+(65*(i-1)),63)))
		Next i

		DEFINE MSDIALOG oDlg TITLE OemToAnsi("Ocorrências Durante Alocação") From 8,05 To 22,55 STYLE DS_MODALFRAME OF oMainWnd	//
		@ 1,002 LISTBOX oOcorr Fields HEADER Space(63) SIZE 170,50
		oOcorr:SetArray(aOcorr)
		oOcorr:bLine := { || {aOcorr[oOcorr:nAT]} }
		@ 75,010 TO 75,185 LABEL "" OF oDlg PIXEL
		@ 82,010 BUTTON OemToAnsi("&Interrompe Processamento") ACTION (oDlg:End(),lRet:=.F.) SIZE 80,11 OF oDlg PIXEL	//
		@ 82,105 BUTTON OemToAnsi("&Continua Processamento") ACTION oDlg:End() SIZE 80,11 OF oDlg PIXEL	//
		ACTIVATE MSDIALOG oDlg
	EndIf

	nTamArq := FSeek(nHdl,0,2)
	nLin := nTamArq / 65
	nTamText := Len(cText) / 65
	If nLin+nTamText < 10
		FSeek(nHdl,0,0)
		For i := 1 to nLin
			cBuffer := Space(65)
			If FRead(nHdl,@cBuffer,65) # 65 .And. !lShowOCR
				Help(" ",1,"FREADERROR",,Str(FError(),2,0),05,38)
			EndIf
		Next i
	EndIf
	FSeek(nHdl,0,2)
	If FWrite(nHdl,cText,Len(cText)) < Len(cText) .And. !lShowOCR
		Help(" ",1,"FWRITERROR",,Str(FError(),2,0),05,38)
	EndIf
	FClose(nHdl)
EndIf
//dbSelectArea(cAlias)

RestArea(aArea)
Return lRet

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³u_A690AddLin  ³ Autor ³ Waldemiro Lustosa   ³ Data ³ 13/09/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Funcao que adiciona espaco e caracteres de Enter e fim de  ³±±
±±³          ³ linha nas linhas do Registro de Ocorrencia.                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
user Function A690AddLin(cText,cLine)

Local cEnter     := Chr(13) + Chr(10)
Local nLoop      := 0

Do While .T. .And. nLoop <= 200
	If Space(2) $ cLine
		cLine := StrTran(cLine, Space(2), Space(1))
		nLoop ++
		Loop
	Else
		Exit
	EndIf
EndDo

If Len(cLine) <= 63
	cText += cLine + Space(63-Len(cLine)) + cEnter
Else
	cText += SubStr(cLine, 01, 63) + cEnter
	ctext += SubStr(cLine, 64, Len(cLine)) + cEnter
EndIf

Return Nil

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ u_CloseSH8   ³ Autor ³Rodrigo de A Sartorio³ Data ³ 03/07/97 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Funcao que fecha o SH8 e o retira da variavel cFopened e da³±±
±±³          ³ abertura do MNU.                                           ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
user Function YCloseSH8()   

If Select("SH8") > 0
	dbSelectArea("SH8")
	RetIndex("SH8")
	dbCloseArea()
EndIf
	UnLockByName("SH8USO"+cNumEmp,.T.,.T.,.T.)
RETURN NIL

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³u_A690AtuSC2  ³ Autor ³ Waldemiro Lustosa   ³ Data ³ 16/09/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Funcao de Atualizacao do SC2 - Ordens de Produ‡„o          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
user Function YAAtuSC2()
Local lOk := .F.
Local lImpRel := .F.
Local oChk
PRIVATE oDlg2
PRIVATE oMeter,nMeter:=0,nTotMeter:=0,oSay
PRIVATE bIncre:={|| oMeter:Set(++nMeter),SysRefresh()}
If !u_Y690IsBat()
	DEFINE MSDIALOG oDlg2 FROM  100,100 TO 360,580 TITLE OemToAnsi("Atenção") PIXEL	//
	@ 10,015 TO 80,215 LABEL "" OF oDlg2  PIXEL
	@ 21,030 SAY oSay VAR OemToAnsi("Carga Máquina efetuada com sucesso !") SIZE 180,8 OF oDlg2  PIXEL	//
	oSay:SetColor(CLR_HRED,GetSysColor(15))
	@ 31,030 SAY OemToAnsi("O cadastro de Solicitações de Compra e o Cadastro de Requisições") SIZE 180,8 OF oDlg2 PIXEL	//
	@ 41,030 SAY OemToAnsi("Empenhadas não foram atualizados, você quer atualizá-los agora ?") SIZE 180,8 OF oDlg2 PIXEL	//
	@ 61,030 CHECKBOX oChk VAR lImpRel PROMPT "Imprime Lista de Faltas" SIZE 66, 10 OF oDlg2 PIXEL //

	@ 90,015 METER oMeter VAR nMeter TOTAL nTotMeter SIZE 200,8 OF oDlg2 NOPERCENTAGE PIXEL
	DEFINE SBUTTON FROM 110,188 TYPE 2 ACTION oDlg2:End() ENABLE OF oDlg2
	DEFINE SBUTTON FROM 110,150 TYPE 1 ACTION (u_YProcAtuSC2(),lOk:=.T.,oDlg2:End()) ENABLE OF oDlg2
	ACTIVATE MSDIALOG oDlg2
	If lOk .And. lImpRel
		MATR350()
		U_YAQuestion(.F.) // Chamo pergunte para restaurar os mv_pars depois da impressao do relatorio
	Endif	
ElseIf l690AtuSC2
	u_YProcAtuSC2()
EndIf
Return

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ u_YProcAtuSC2 ³ Autor ³Rodrigo de A Sartorio³ Data ³ 03/07/97 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Processa Atualizacao do SC2 - Ordens de Produ‡„o           ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
user Function YProcAtuSC2()
Local cAlias	:= Alias(), nIndexOrd := IndexOrd(), cOp, cOpPos
Local cFilSC2	:= u_Y690FilSC2()
Local nTamSX1   := Len(SX1->X1_GRUPO)
Local lAltGra	:= posicione("SX1", 1, PADR("MTA650",nTamSX1)+"01", "X1_PRESEL") == 1
Local lIntPPI   := PCPIntgPPI()
Local lMT690DAT := ExistBlock("MT690DAT")

dbSelectArea("CARGA")
dbSetOrder(1)
dbSelectArea("SC1")
dbSetOrder(4)
dbSelectArea("SD4")
dbSetOrder(2)
dbSelectArea("SC2")
dbSeek(xFilial("SC2") + mv_par09, .T.)
If !u_Y690IsBat()
	oMeter:nTotal:=nTotMeter:= LastRec()
EndIf
While !Eof() .And. xFilial("SC2") == C2_FILIAL .And. C2_NUM+C2_ITEM+C2_SEQUEN+C2_ITEMGRD <= mv_par10
	If !u_Y690IsBat()
		EVAL(bIncre)
	EndIf
	// Filtra as Ordens de Producao de Acordo com os parametros selecionados
	If !&(cFilSC2)
		dbSkip()
		Loop
	EndIf
	// Desconsiderando as OPs j  sacramentadas, pois elas tem informa‡äes no Arquivo "CARGA"
	// corretas apenas para visualiza‡„o, as informa‡äes corretas para processamento j  foram
	// utilizadas anteriormente e est„o no Arquivo "SH8".
	If C2_STATUS == "S" .And. mv_par05 == 1
		dbSkip()
		Loop
	EndIf
	cOp := C2_NUM+C2_ITEM+C2_SEQUEN+C2_ITEMGRD
	dbSelectArea("CARGA")
	dbSeek(xFilial("SH8")+cOp)
	If Found()
		dbSelectArea("SC2")
		RecLock("SC2",.F.)
		Replace  C2_DATAJI  With CARGA->H8_DTINI,;
			C2_HORAJI  With CARGA->H8_HRINI,;
			C2_RECURSO With CARGA->H8_RECURSO
		MsUnLock()
		dbSelectArea("CARGA")
		cOpPos := Substr(cOp,1,8)+StrZero(Val(Substr(cOp,9,3))+1,3)
		dbSeek(xFilial("SH8")+cOpPos,.T.)
		dbSkip(-1)
		dbSelectArea("SC2")
		RecLock("SC2",.F.)
		Replace  C2_DATAJF with CARGA->H8_DTFIM,;
			C2_HORAJF with CARGA->H8_HRFIM
		MsUnLock()
	Else
		dbSelectArea("SC2")
		dbSkip()
		Loop
	Endif
	//-- Atualiza datas das SC`s
	dbSelectArea("SC1")
	dbSeek(xFilial("SC1")+cOp)
	While C1_FILIAL+C1_OP == xFilial("SC1")+cOp
		If !Empty(SC2->C2_DATAJI)
			RecLock("SC1",.F.)
			Replace C1_DATPRF with SC2->C2_DATAJI
			MsUnlock()
		EndIf
		//-- Atualiza datas das cotacoes
		dbSelectArea("SC8")
		dbSetOrder(3)
		dbSeek(xFilial("SC8")+SC1->(C1_COTACAO+C1_PRODUTO))
		While !EOF() .And. C8_FILIAL+C8_NUM+C8_PRODUTO == xFilial("SC8")+SC1->(C1_COTACAO+C1_PRODUTO)
			RecLock("SC8",.F.)
			Replace C8_DATPRF With SC2->C2_DATAJI
			MsUnLock()
			dbSkip()
		End
		dbSelectArea("SC1")
		dbSkip()
	End
	//-- Atualiza datas das AE`s
	dbSelectArea("SC7")
	dbSetOrder(8)
	dbSeek(xFilial("SC7")+SC2->C2_NUM+SC2->C2_ITEM+SC2->C2_SEQUEN)
	While ! Eof() .And. Alltrim(C7_FILIAL+If(!lAltGra,C7_OP,Left(C7_OP,Len(cOp)))) == Alltrim(xFilial("SC7")+SC2->C2_NUM+SC2->C2_ITEM+SC2->C2_SEQUEN+If(lAltGra,"",SC2->C2_ITEMGRD))
		If C7_TIPO == 2
			RecLock("SC7", .F.)
			Replace C7_DATPRF With SC2->C2_DATAJI
			MsUnlock()
		EndIf
		dbSkip()
	End
	//-- Atualiza datas dos empenhos
	dbSelectArea("SD4")
	dbSeek(xFilial("SD4")+cOp)
	While D4_FILIAL+D4_OP == xFilial("SD4")+cOp
		If !Empty(SC2->C2_DATAJI)
			RecLock("SD4",.F.)
			Replace D4_DATA with SC2->C2_DATAJI
			MsUnlock()
		EndIf
		dbSkip()
	End
	dbSelectArea("SC2")
	//Ponto de entrada após as atualizacoes de datas no SC2, SC1 e SD4
	If lMT690DAT
		ExecBlock("MT690DAT",.F.,.F.,{cOP,C2_DATAJI,C2_DATAJF})
	EndIf
	dbSkip()
End
If !u_Y690IsBat()
	EVAL(bIncre)
EndIf
A690CheckSC2(.F.)
dbSelectArea("SC1")
dbSetOrder(1)
dbSelectArea("SD4")
dbSetOrder(1)
dbSelectArea(cAlias)
dbSetOrder(nIndexOrd)
Return NIL

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ u_Y690Relato ³ Autor ³Rodrigo de A Sartorio³ Data ³ 03/07/97 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Funcao que fecha o SH8, chama o relatorio de carga m quina,³±±
±±³          ³ abre o arquivo como exclusivo novamente e volta para o Dlg.³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
user Function Y690Relato()
If ExistBlock("A690NREL")
    ExecBlock("A690NREL",.F.,.F.)
Else
	dbSelectArea("SB1")
	MATR815()    
Endif		

//If OpenSemSH8()
//	U_YAQuestion(.F.)
	
	//-- Fecha/Libera Semaforo SH8
	//ClosSemSH8()
//Else
	oDlg:End()
//EndIf
RETURN NIL

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³u_Y690NomeLongo³ Autor ³ Marcelo Iuspa      ³ Data ³05/07/2000³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Verifica de diretório é nome longo                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ cPath  : Nome do diretório a ser checado                   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAPCP       ³                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/

user Function Y690NomeLongo(cPath)
Local x
Local nTmp := 0
Local lRet := .F.
For x := 1 to Len(cPath)
	If (nTmp := If(SubStr(cPath, x, 1) $ ":\", 0, nTmp + 1)) > 8
		lRet := .T.
		Exit
	Endif
Next
Return(lRet)

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³u_Y690RecLin ³ Autor ³ Marcelo Iuspa        ³ Data ³11/03/2002³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna a linha de producao de um recurso                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ cRecurso: Recurso a ter a linha retornada                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAPCP       ³                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
user Function Y690RecLin(cRecurso)
Local aSave := {SH1->(IndexOrd()), SH1->(RecNo()), Alias()}
Local cRet  := ""
dbSelectArea("SH1")
dbSetOrder(1)
If dbSeek(xFilial("SH1") + cRecurso)
	cRet := SH1->H1_LINHAPR
Endif
dbSetOrder(  aSave[1])
dbGoto(      aSave[2])
dbSelectArea(aSave[3])
Return(cRet)	

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³u_Y690NaoAlocada ³ Autor ³ Marcelo Iuspa    ³ Data ³09/12/2004³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna ou seta OP como NAO alocada                        ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ cOp    : OP a retornar ou setar                            ³±±
±±³          ³ lInclui: Se .T. inclui a OP na lista das NAO alocadas      ³±±
±±³          ³ lReseta: Reseta variaveis STATICs                          ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ SIGAPCP       ³                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
user Function Y690NaoAlocada(cOp, lInclui, lReseta)
Static  aOps    := {}
Local   nSeek   := 0
Default lInclui := .F.
Default lReseta := .F.

If lReseta
	aOps := {}
	Return(.T.)
Endif

nSeek := aScan(aOps, cOp)

If lInclui .And. nSeek == 0
	Aadd(aOps, cOp)
	Return(.F.)
Else
	Return(nSeek > 0)
Endif

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³u_Y690IsBat      ³ Autor ³Erike Y. da Silva ³ Data ³27/04/2005³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna variavel static que indica se o processamento esta ³±±
±±³          ³ sendo executado em batch ou nao usando lBat e IsBlind()    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690?      ³                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
user Function Y690IsBat()
Return lIsBatch

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³  YASetupG     ³ Autor ³Erike Y. da Silva ³ Data ³16/05/2005³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Retorna variavel static com o valor do setup atual, caso   ³±±
±±³          ³ exista.                                                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690?      ³                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
user Function YASetupG(nSetup)	
Return __nSetupAt := If(nSetup==NIL,__nSetupAt,nSetup)


/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³u_Y690Meter      ³ Autor ³Microsiga         ³ Data ³17/12/2007³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Cria Regua de processamento para a visualizacao do Carga   ³±±
±±³          ³ Maquina.                                                   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690?                                                   ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
User Function Y690Meter(oCenterPanel)
Local oButMeter

@ 45,030 TO 100,320 LABEL "Executa Visualização" OF oCenterPanel  PIXEL //
@ 65,050 METER oRegua VAR nRegua TOTAL nTotRegua SIZE 251,8 OF oCenterPanel NOPERCENTAGE PIXEL
bBlock := {|| oRegua:Set(++nRegua),SysRefresh()}
DEFINE SBUTTON oButMeter FROM 80,050 TYPE 1 ACTION (oButMeter:lActive := .F., U_YAVisual(),A690ClrScr(oButMeter)) ENABLE OF oCenterPanel PIXEL

Return Nil

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³A690ClrScr     ³ Autor ³Microsiga         ³ Data ³17/12/2007³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Limpa Objetos na Tela                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690?                                                   ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function A690ClrScr(oButton)

oButton:lActive := .T.
If (oRegua<>Nil)
	oRegua:Set(0)
EndIf
SysRefresh()

Return Nil
/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³A690Report     ³ Autor ³Microsiga         ³ Data ³17/12/2007³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Executa chamada do Relatorio                               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA690?                                                   ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function A690Report(oCenterPanel)
Local oButReport

@ 45,030 TO 100,320 LABEL "Executa Relatório" OF oCenterPanel  PIXEL //
DEFINE SBUTTON oButReport FROM 80,050 TYPE 1 ACTION (oButReport:lActive := .F., u_Y690Relato(),A690ClrScr(oButReport)) ENABLE OF oCenterPanel PIXEL

Return Nil    

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³u_Y690FilNum  ³ Autor ³ Anieli Rodrigues    ³ Data ³ 12.08.   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Funcao utilizada para converter as filiais com codigo      ³±±
±±³          ³ caracter para codigo numerico /  GESTAO DE EMPRESAS        ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpC1 = Codigo da Filial                                   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ MATA330                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
user Function Y690FilNum(cFil)
Local aAreaAnt  := GetArea()
Local aAreaSM0  := SM0->(GetArea())
Local nRet      := Val(cFil)
Local cSeek     := ''
Local nContador := 100

If cFil > '99' .or. nRet > 99
	dbSelectArea("SM0")
	dbSetOrder(1)
	dbSeek(cSeek:=FWGrpCompany())
	Do While !Eof() .And. cSeek == SM0->M0_CODIGO
		If AllTrim(cFil) == AllTrim(SM0->M0_CODFIL)
			nRet := nContador
			Exit		
		EndIf
		nContador++
		dbSkip()	
	EndDo
EndIf	

RestArea(aAreaSM0)
RestArea(aAreaAnt)             
Return nRet     

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±
±±ºFuncao    ³Carrega CT ºMichele Girardi  ºData	|26/11/2013   º        ±±
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±
±±ºUso       ³ MATA690                                                    º±±
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/
user Function Y690CarregaCT(cNRecurso)

Local cCTrab 

if mv_par31 == 1
     Return Nil
EndIf

dbSelectArea("SH1")
dbSetOrder(1)
DbSeek(xFilial("SH1")+cNRecurso)

if !Empty(SH1->H1_CTRAB)
	cCTrab := SH1->H1_CTRAB
	Return cCTrab	
EndIf

return nil
